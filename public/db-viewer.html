<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üóÑÔ∏è Database Viewer - Palm Oil Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">üóÑÔ∏è Database Viewer</h1>
                <div class="flex space-x-2">
                    <button onclick="loadTables()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        üîÑ Refresh
                    </button>
                    <button onclick="showSchema()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        üìã Schema
                    </button>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="mb-6">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-yellow-800">
                        üîê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </p>
                </div>
                <div class="flex space-x-4">
                    <input type="email" id="email" placeholder="Email" value="admin@palmoil.com" 
                           class="border rounded px-3 py-2 flex-1">
                    <input type="password" id="password" placeholder="Password" value="admin123"
                           class="border rounded px-3 py-2 flex-1">
                    <button onclick="login()" class="bg-indigo-500 text-white px-6 py-2 rounded hover:bg-indigo-600">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>

            <!-- Tables Overview -->
            <div id="tablesOverview" class="hidden mb-6">
                <h2 class="text-xl font-semibold mb-4">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <div id="tablesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Tables will be loaded here -->
                </div>
            </div>

            <!-- Data Viewer -->
            <div id="dataViewer" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="tableTitle" class="text-xl font-semibold">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á</h2>
                    <div class="flex space-x-2">
                        <select id="limitSelect" onchange="loadTableData(getCurrentTable())" 
                                class="border rounded px-3 py-1">
                            <option value="50">50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                            <option value="100" selected>100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                            <option value="200">200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                            <option value="500">500 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                        </select>
                        <button onclick="exportData()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                            üì§ Export JSON
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <div id="tableContent">
                        <!-- Table data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Schema Viewer -->
            <div id="schemaViewer" class="hidden">
                <h2 class="text-xl font-semibold mb-4">üèóÔ∏è ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <div id="schemaContent">
                    <!-- Schema will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentTableData = null;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API URL
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001'
            : 'https://api-server-production-4ba0.up.railway.app';        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentToken = result.token;
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('tablesOverview').classList.remove('hidden');
                    loadTables();
                } else {
                    alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function loadTables() {
            if (!currentToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/db-tables`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const result = await response.json();
                
                if (response.ok) {
                    displayTables(result.tables);
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ' + result.error);
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        function displayTables(tables) {
            const container = document.getElementById('tablesList');
            container.innerHTML = tables.map(table => `
                <div class="bg-gray-50 border rounded-lg p-4 cursor-pointer hover:bg-gray-100"
                     onclick="loadTableData('${table.table}')">
                    <h3 class="font-semibold text-lg">${getTableIcon(table.table)} ${table.table}</h3>
                    <p class="text-gray-600">${table.count.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
            `).join('');
        }

        function getTableIcon(tableName) {
            const icons = {
                'users': 'üë•',
                'harvest_data': 'üåæ',
                'fertilizer_data': 'üå±',
                'palm_tree_data': 'üå¥',
                'notes_data': 'üìù'
            };
            return icons[tableName] || 'üìã';
        }

        async function loadTableData(tableName) {
            if (!currentToken) return;

            const limit = document.getElementById('limitSelect').value;

            try {
                const response = await fetch(`${API_BASE}/api/admin/db-data/${tableName}?limit=${limit}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentTableData = result;
                    displayTableData(result);
                    document.getElementById('dataViewer').classList.remove('hidden');
                    document.getElementById('tableTitle').textContent = `${getTableIcon(tableName)} ${tableName} (${result.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + result.error);
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        function displayTableData(result) {
            const container = document.getElementById('tableContent');
            
            if (result.data.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ</p>';
                return;
            }

            const headers = Object.keys(result.data[0]);
            const tableHtml = `
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            ${headers.map(header => `<th class="px-4 py-2 border-b text-left text-sm font-medium text-gray-700">${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${result.data.map(row => `
                            <tr class="hover:bg-gray-50">
                                ${headers.map(header => `<td class="px-4 py-2 border-b text-sm">${formatValue(row[header])}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHtml;
        }

        function formatValue(value) {
            if (value === null) return '<span class="text-gray-400">NULL</span>';
            if (typeof value === 'string' && value.length > 50) {
                return value.substring(0, 50) + '...';
            }
            return value;
        }

        async function showSchema() {
            if (!currentToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/db-schema/users`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const result = await response.json();
                
                if (response.ok) {
                    displaySchema(result.tables);
                    document.getElementById('schemaViewer').classList.remove('hidden');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Schema: ' + result.error);
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        function displaySchema(tables) {
            const container = document.getElementById('schemaContent');
            container.innerHTML = tables.map(table => `
                <div class="mb-6 bg-gray-50 border rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-2">${getTableIcon(table.name)} ${table.name}</h3>
                    <pre class="bg-gray-800 text-green-400 p-4 rounded text-sm overflow-x-auto">${table.sql}</pre>
                </div>
            `).join('');
        }

        function getCurrentTable() {
            return currentTableData ? currentTableData.table : null;
        }

        function exportData() {
            if (!currentTableData) return;
            
            const dataStr = JSON.stringify(currentTableData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentTableData.table}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Auto-login ‡∏´‡∏≤‡∏Å token ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        window.onload = function() {
            console.log('üóÑÔ∏è Database Viewer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Palm Oil Management System');
            console.log('üì° API Base:', API_BASE);
        };
    </script>
</body>
</html>