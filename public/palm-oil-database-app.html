<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palm Oil Business Manager - Database Version</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https:; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com; 
        script-src-attr 'unsafe-inline';
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; 
        connect-src 'self' http://localhost:3001 https://unpkg.com *.up.railway.app; 
        img-src 'self' data: https:;
        font-src 'self' https:;
        worker-src 'none';
    ">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React ‡πÅ‡∏•‡∏∞ ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü -->
    <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
        // Initialize Chart.js detection after load
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart !== 'undefined') {
                console.log('‚úÖ Chart.js 4.4.0 loaded!', typeof Chart);
                window.chartJsLoaded = true;
            } else {
                console.error('‚ùå Failed to load Chart.js');
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Mobile optimizations for voice chat */
        @media (max-width: 640px) {
            .chat-input-mobile {
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .voice-button {
                touch-action: manipulation; /* Better touch response */
                min-height: 44px; /* iOS recommended touch target size */
                min-width: 44px;
            }
            
            .chat-message {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
        }
        
        /* Voice recording animation */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .recording-pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Configuration - Environment-aware
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001/api'
            : 'https://palmfarmnew-production.up.railway.app/api';
        
        console.log('üîß API_BASE_URL configured as:', API_BASE_URL);
        console.log('üîß Current hostname:', window.location.hostname);
        console.log('üîß Using Railway API for production');
        
        // API Helper Functions
        const api = {
            // Auth
            login: async (email, password) => {
                console.log('üîê Attempting login with:', { email, password: '***' });
                const loginUrl = `${API_BASE_URL}/auth/login`;
                console.log('üîó Login URL:', loginUrl);
                
                try {
                    const response = await fetch(loginUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    
                    console.log('üì° Login response status:', response.status);
                    console.log('üì° Login response URL:', response.url);
                    
                    const contentType = response.headers.get('content-type');
                    console.log('üì° Content-Type:', contentType);
                    
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        console.log('üì° Login response data:', data);
                        
                        if (!response.ok) {
                            throw new Error(data.error || 'Login failed');
                        }
                        
                        return data;
                    } else {
                        const text = await response.text();
                        console.log('üì° Login response (text):', text.substring(0, 200));
                        throw new Error('Server returned non-JSON response');
                    }
                    
                } catch (error) {
                    console.error('üö® Fetch error:', error);
                    throw error;
                }
            },
            
            register: async (username, email, password) => {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                return response.json();
            },
            
            // Generic API call with auth
            call: async (endpoint, options = {}) => {
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                };
                
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        ...options,
                        headers
                    });
                    
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.reload();
                        return;
                    }
                    
                    // Check if response is ok
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API Error ${response.status}:`, errorText);
                        throw new Error(`API Error ${response.status}: ${errorText}`);
                    }
                    
                    // Try to parse JSON
                    const responseText = await response.text();
                    if (!responseText.trim()) {
                        console.warn('Empty response from server');
                        return {};
                    }
                    
                    try {
                        return JSON.parse(responseText);
                    } catch (jsonError) {
                        console.error('JSON Parse Error:', jsonError);
                        console.error('Response text:', responseText);
                        throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
                    }
                    
                } catch (fetchError) {
                    console.error('Fetch Error:', fetchError);
                    throw fetchError;
                }
            }
        };

        // Utility Functions
        const formatDate = (dateString) => {
            if (!dateString) return '-';

            // Handle DD/MM/YYYY format (common in the database)
            if (typeof dateString === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
                const parts = dateString.split('/');
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-based in Date constructor
                const year = parseInt(parts[2]);

                // Validate the date components
                if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900 && year <= 2100) {
                    const date = new Date(year, month, day);
                    // Verify the date was created correctly (handles invalid dates like Feb 30th)
                    if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                        const formattedDay = String(date.getDate()).padStart(2, '0');
                        const formattedMonth = String(date.getMonth() + 1).padStart(2, '0');
                        const formattedYear = date.getFullYear();
                        return `${formattedDay}-${formattedMonth}-${formattedYear}`;
                    }
                }
                return '-'; // Invalid date components
            }

            // Fallback to standard date parsing for ISO format or other formats
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        };

        // Helper function to format dates for HTML date input (YYYY-MM-DD)
        const formatDateForInput = (dateString) => {
            if (!dateString) return '';

            // Handle DD/MM/YYYY format (common in the database)
            if (typeof dateString === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
                const parts = dateString.split('/');
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-based in Date constructor
                const year = parseInt(parts[2]);

                // Validate the date components
                if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900 && year <= 2100) {
                    const date = new Date(year, month, day);
                    // Verify the date was created correctly (handles invalid dates like Feb 30th)
                    if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                        const formattedDay = String(date.getDate()).padStart(2, '0');
                        const formattedMonth = String(date.getMonth() + 1).padStart(2, '0');
                        const formattedYear = date.getFullYear();
                        return `${formattedYear}-${formattedMonth}-${formattedDay}`;
                    }
                }
                return ''; // Invalid date components
            }

            // Handle DD-MM-YYYY format
            if (typeof dateString === 'string' && /^\d{1,2}-\d{1,2}-\d{4}$/.test(dateString)) {
                const parts = dateString.split('-');
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-based in Date constructor
                const year = parseInt(parts[2]);

                // Validate the date components
                if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900 && year <= 2100) {
                    const date = new Date(year, month, day);
                    // Verify the date was created correctly (handles invalid dates like Feb 30th)
                    if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                        const formattedDay = String(date.getDate()).padStart(2, '0');
                        const formattedMonth = String(date.getMonth() + 1).padStart(2, '0');
                        const formattedYear = date.getFullYear();
                        return `${formattedYear}-${formattedMonth}-${formattedDay}`;
                    }
                }
                return ''; // Invalid date components
            }

            // Fallback to standard date parsing for ISO format or other formats
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${year}-${month}-${day}`;
        };

        // Helper function to safely parse dates for sorting
        const parseDateForSorting = (dateString) => {
            if (!dateString) return new Date(0); // Return epoch for null dates

            // Handle DD/MM/YYYY format
            if (typeof dateString === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
                const parts = dateString.split('/');
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-based
                const year = parseInt(parts[2]);

                if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 1900 && year <= 2100) {
                    const date = new Date(year, month, day);
                    if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                        return date;
                    }
                }
                return new Date(0); // Invalid date
            }

            // Fallback to standard parsing
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? new Date(0) : date;
        };

        // Helper function to format dates in Thai format
        const formatDateThai = (dateString) => {
            if (!dateString) return '-';

            const monthsThai = [
                '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            ];

            // Handle YYYY-MM-DD format (ISO format from database)
            let date;
            if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                date = new Date(dateString);
            } else if (typeof dateString === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
                // Handle DD/MM/YYYY format
                const parts = dateString.split('/');
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-based
                const year = parseInt(parts[2]);
                date = new Date(year, month, day);
            } else {
                date = new Date(dateString);
            }

            if (isNaN(date.getTime())) return '-';

            const day = date.getDate();
            const monthThai = monthsThai[date.getMonth()];
            const year = date.getFullYear() + 543; // Convert to Buddhist era

            return `${day} ${monthThai} ${year}`;
        };

        const App = () => {
          const [currentUser, setCurrentUser] = useState(null);
          const [activeTab, setActiveTab] = useState('login');
          const [showGeminiChat, setShowGeminiChat] = useState(false);
          const [geminiMessages, setGeminiMessages] = useState([]);
          const [geminiInput, setGeminiInput] = useState('');
          const [geminiLoading, setGeminiLoading] = useState(false);
          const [geminiStatus, setGeminiStatus] = useState('unknown'); // 'ready', 'unavailable', 'unknown'
          const [loading, setLoading] = useState(false);
          
          // Voice-related states
          const [isListening, setIsListening] = useState(false);
          const [isSpeaking, setIsSpeaking] = useState(false);
          const [voiceSupported, setVoiceSupported] = useState(false);
          const [speechRecognition, setSpeechRecognition] = useState(null);

          // Search-related states
          const [searchQuery, setSearchQuery] = useState('');
          const [searchResults, setSearchResults] = useState([]);
          const [searchLoading, setSearchLoading] = useState(false);

          // Data states
          const [harvestData, setHarvestData] = useState([]);
          const [harvestSortOrder, setHarvestSortOrder] = useState('desc'); // 'desc' = latest first
          const [fertilizerData, setFertilizerData] = useState([]);
          const [fertilizerSortOrder, setFertilizerSortOrder] = useState('desc'); // 'desc' = latest first
          const [palmTreeData, setPalmTreeData] = useState([]);
          const [palmTreeSortOrder, setPalmTreeSortOrder] = useState('desc'); // 'desc' = latest first
          const [notesData, setNotesData] = useState([]);
          const [notesSortOrder, setNotesSortOrder] = useState('desc'); // 'desc' = latest first
          const [expandedNotes, setExpandedNotes] = useState({}); // For expand/collapse notes content
          const [users, setUsers] = useState([]);
          const [stats, setStats] = useState({});
          const [yearlyStats, setYearlyStats] = useState({ harvest: [], fertilizer: [], palmtrees: [] });

          // Palm tree visualization states
          const [palmTreeList, setPalmTreeList] = useState([]);
          const [selectedTreeHistory, setSelectedTreeHistory] = useState(null);
          const [showTreeModal, setShowTreeModal] = useState(false);

          // Edit modal states
          const [showEditModal, setShowEditModal] = useState(false);
          const [editingItem, setEditingItem] = useState(null);
          const [editType, setEditType] = useState(''); // 'harvest', 'fertilizer', etc.
          const [selectedTreeId, setSelectedTreeId] = useState('');
          const [editingUser, setEditingUser] = useState(null);

          // Check for existing token on load
          useEffect(() => {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            if (token && user) {
              const userObj = JSON.parse(user);
              setCurrentUser(userObj);
              setActiveTab('dashboard');
              loadAllData(userObj);
            }
            
            // Check API status on startup
            checkApiStatus();
            
            // Initialize voice features
            initializeVoiceFeatures();
          }, []);
          
          // Initialize voice features
          const initializeVoiceFeatures = () => {
            // Check for Speech Recognition support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const speechSynthesis = window.speechSynthesis;
            
            if (SpeechRecognition && speechSynthesis) {
              setVoiceSupported(true);
              
              const recognition = new SpeechRecognition();
              recognition.continuous = false;
              recognition.interimResults = false;
              recognition.lang = 'th-TH'; // Thai language
              
              recognition.onstart = () => {
                console.log('üé§ Voice recognition started');
                setIsListening(true);
              };
              
              recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('üó£Ô∏è Voice input:', transcript);
                setIsListening(false);
                
                // Set input based on active tab
                if (activeTab === 'search') {
                  setSearchQuery(transcript);
                  // Auto-search after voice input
                  setTimeout(() => {
                    if (transcript.trim()) {
                      // Simulate search query
                      setSearchQuery(transcript);
                      setTimeout(() => handleSearchQuery(), 500);
                    }
                  }, 1000);
                } else {
                  setGeminiInput(transcript);
                  // Auto-send after voice input (for hands-free operation)
                  setTimeout(() => {
                    if (transcript.trim()) {
                      const fakeEvent = { preventDefault: () => {} };
                      handleGeminiSend(fakeEvent);
                    }
                  }, 1000);
                }
              };
              
              recognition.onerror = (event) => {
                console.error('‚ùå Voice recognition error:', event.error);
                setIsListening(false);
                
                let errorMessage = '';
                switch (event.error) {
                  case 'not-allowed':
                    errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå';
                    break;
                  case 'no-speech':
                    errorMessage = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    break;
                  case 'network':
                    errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
                    break;
                  default:
                    errorMessage = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${event.error}`;
                }
                
                // Show error message to user
                const errorMsg = { 
                  id: Date.now(), 
                  text: `üé§ ${errorMessage}`, 
                  sender: 'system',
                  timestamp: new Date().toISOString()
                };
                setGeminiMessages(prev => [...prev, errorMsg]);
              };
              
              recognition.onend = () => {
                console.log('üé§ Voice recognition ended');
                setIsListening(false);
              };
              
              setSpeechRecognition(recognition);
              
              // Request microphone permission on mobile
              if ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                  .then(() => console.log('üé§ Microphone permission granted'))
                  .catch(() => console.log('‚ùå Microphone permission denied'));
              }
            } else {
              console.warn('‚ö†Ô∏è Voice features not supported in this browser');
              setVoiceSupported(false);
            }
          };
          
          // Check API status function
          const checkApiStatus = async () => {
            try {
              const response = await fetch(`${API_BASE_URL}/status`);
              const status = await response.json();
              console.log('üîç API Status:', status);
              
              if (status.search?.mode === 'offline') {
                console.log('‚úÖ Using Offline Search Engine');
                setGeminiStatus('ready');
              } else if (!status.gemini?.configured) {
                console.warn('‚ö†Ô∏è Gemini API key is not configured on server');
                setGeminiStatus('unavailable');
              } else {
                setGeminiStatus('ready');
              }
            } catch (error) {
              console.error('‚ùå Failed to check API status:', error);
              setGeminiStatus('unavailable');
            }
          };

          // Search Functions
          const handleSearchQuery = async () => {
            if (!searchQuery.trim()) return;
            
            setSearchLoading(true);
            try {
              const token = localStorage.getItem('token');
              const response = await fetch(`${API_BASE_URL}/chat`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  message: searchQuery.trim(),
                  context: {
                    currentDate: new Date().toLocaleDateString('th-TH'),
                    currentDateISO: new Date().toISOString().split('T')[0],
                    currentYear: new Date().getFullYear(),
                    buddhistYear: new Date().getFullYear() + 543,
                    currentMonth: new Date().getMonth() + 1,
                    userName: currentUser?.email || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
                  }
                })
              });

              const data = await response.json();
              
              if (response.ok) {
                const newResult = {
                  query: searchQuery,
                  answer: data.message,
                  timestamp: new Date().toISOString()
                };
                
                setSearchResults(prev => [newResult, ...prev]);
                setSearchQuery('');
              } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + (data.message || data.error));
              }
            } catch (error) {
              console.error('Search error:', error);
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            } finally {
              setSearchLoading(false);
            }
          };

          const toggleVoiceInput = () => {
            if (isListening) {
              stopVoiceRecording();
            } else {
              startVoiceRecording();
            }
          };
          
          // Voice Functions
          const startVoiceRecording = () => {
            if (speechRecognition && !isListening) {
              speechRecognition.start();
            }
          };
          
          const stopVoiceRecording = () => {
            if (speechRecognition && isListening) {
              speechRecognition.stop();
            }
          };
          
          const speakText = (text) => {
            if (!window.speechSynthesis) return;
            
            // Stop any current speech
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'th-TH'; // Thai language
            utterance.rate = 0.9; // Slightly slower for better understanding
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onstart = () => {
              console.log('üîä Started speaking');
              setIsSpeaking(true);
            };
            
            utterance.onend = () => {
              console.log('üîá Finished speaking');
              setIsSpeaking(false);
            };
            
            utterance.onerror = (event) => {
              console.error('‚ùå Speech synthesis error:', event.error);
              setIsSpeaking(false);
            };
            
            window.speechSynthesis.speak(utterance);
          };
          
          const stopSpeaking = () => {
            if (window.speechSynthesis) {
              window.speechSynthesis.cancel();
              setIsSpeaking(false);
            }
          };

          // Load yearly statistics for reports
          const loadYearlyStats = async () => {
            try {
              console.log('üîç Loading yearly statistics...');
              const data = await api.call('/yearly-stats');
              console.log('üìä Yearly stats loaded:', data);
              setYearlyStats(data || { harvest: [], fertilizer: [], palmtrees: [] });
            } catch (error) {
              console.error('‚ùå Error loading yearly stats:', error);
              setYearlyStats({ harvest: [], fertilizer: [], palmtrees: [] });
            }
          };

          // Load yearly stats when switching to reports tab
          useEffect(() => {
            if (activeTab === 'reports' && currentUser) {
              console.log('üìä Loading yearly stats for reports tab...');
              loadYearlyStats();
            }
          }, [activeTab, currentUser]);

          // Load users when switching to users tab
          useEffect(() => {
            if (activeTab === 'users' && currentUser?.role === 'admin') {
              console.log('Loading users data for admin...');
              loadUsersData();
            }
          }, [activeTab, currentUser]);

          // Load all data
          const loadAllData = async (user = currentUser) => {
            try {
              setLoading(true);
              console.log('Loading data, currentUser:', user);
              console.log('Is admin?', user?.role === 'admin');
              
              // Add delay between requests to prevent rate limiting
              const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
              
              // Load data sequentially with delays to prevent "Too many requests"
              const harvestRes = await api.call('/harvest');
              await delay(100);
              
              const fertilizerRes = await api.call('/fertilizer');
              await delay(100);
              
              const palmtreeRes = await api.call('/palmtrees');
              await delay(100);
              
              const notesRes = await api.call('/notes');
              await delay(100);
              
              const statsRes = await api.call('/stats');
              await delay(100);
              
              const palmTreeListRes = await api.call('/palmtrees/list');
              await delay(100);
              
              const usersRes = user?.role === 'admin' ? await api.call('/users') : [];

              console.log('API responses:', {
                harvest: harvestRes?.length || 0,
                fertilizer: fertilizerRes?.length || 0,
                palmtrees: palmtreeRes?.length || 0,
                notes: notesRes?.length || 0,
                stats: statsRes,
                users: usersRes?.length || 0
              });

              setHarvestData((harvestRes || []).sort((a, b) => parseDateForSorting(b.date) - parseDateForSorting(a.date)));
              setFertilizerData((fertilizerRes || []).sort((a, b) => parseDateForSorting(b.date) - parseDateForSorting(a.date)));
              setPalmTreeData((palmtreeRes || []).sort((a, b) => parseDateForSorting(b.harvest_date || b.date) - parseDateForSorting(a.harvest_date || a.date)));
              setNotesData((notesRes || []).sort((a, b) => parseDateForSorting(b.date) - parseDateForSorting(a.date)));
              setStats(statsRes || {});
              setPalmTreeList(palmTreeListRes || []);
              if (user?.role === 'admin') {
                console.log('Setting users data:', usersRes);
                setUsers(usersRes || []);
              } else {
                console.log('Not admin, not loading users');
              }

              console.log('‚úÖ All data loaded successfully!');
              console.log('üìä Data summary:', {
                harvest: harvestRes?.length || 0,
                fertilizer: fertilizerRes?.length || 0,
                palmtrees: palmtreeRes?.length || 0,
                notes: notesRes?.length || 0
              });
            } catch (error) {
              console.error('Error loading data:', error);
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            } finally {
              setLoading(false);
            }
          };

          // Generate palm tree names A1 to L26
          const generatePalmTreeNames = () => {
            const trees = [];
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').slice(0, 12); // A to L
            for (let i = 0; i < letters.length; i++) {
              for (let j = 1; j <= 26; j++) {
                trees.push(`${letters[i]}${j}`);
              }
            }
            return trees;
          };

          const palmTrees = generatePalmTreeNames();

          // Login handler
          const handleLogin = async (email, password) => {
            try {
              setLoading(true);
              const result = await api.login(email, password);
              
              if (result.error) {
                alert(result.error);
                return;
              }
              
              localStorage.setItem('token', result.token);
              localStorage.setItem('user', JSON.stringify(result.user));
              setCurrentUser(result.user);
              setActiveTab('dashboard');
              await loadAllData(result.user);
            } catch (error) {
              console.error('‚ùå Login error:', error);
              alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            } finally {
              setLoading(false);
            }
          };

          // Signup handler
          const handleSignup = async (username, email, password) => {
            try {
              setLoading(true);
              const result = await api.register(username, email, password);
              
              if (result.error) {
                alert(result.error);
                return;
              }
              
              alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
              setActiveTab('login');
            } catch (error) {
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
            } finally {
              setLoading(false);
            }
          };

          // Logout handler
          const handleLogout = () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            setCurrentUser(null);
            setActiveTab('login');
          };

          // Load users data for admin
          const loadUsersData = async () => {
            if (currentUser?.role === 'admin') {
              try {
                console.log('Loading users data...');
                const usersRes = await api.call('/users');
                console.log('Users loaded:', usersRes);
                setUsers(usersRes || []);
              } catch (error) {
                console.error('Error loading users:', error);
              }
            }
          };

          // User management functions
          const handleUserToggle = async (userId) => {
            try {
              await api.call(`/users/${userId}/toggle`, { method: 'PUT' });
              await loadAllData();
            } catch (error) {
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
            }
          };

          const handleUserDelete = async (userId) => {
            if (window.confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?')) {
              try {
                await api.call(`/users/${userId}`, { method: 'DELETE' });
                await loadAllData();
              } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
              }
            }
          };

          const handleUserRoleChange = async (userId, newRole) => {
            try {
              await api.call(`/users/${userId}/role`, { 
                method: 'PUT',
                body: JSON.stringify({ role: newRole })
              });
              await loadAllData();
            } catch (error) {
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó');
            }
          };

          // CSV Export/Import Functions
          const exportToCSV = (data, filename, headers) => {
            if (!data || data.length === 0) {
              alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
              return;
            }
            
            // Enhanced CSV export to handle long text with quotes, commas, and newlines
            const escapeCsvValue = (value) => {
              if (!value) return '""';
              const str = String(value);
              // Escape quotes and wrap in quotes if contains comma, quote, or newline
              if (str.includes('"') || str.includes(',') || str.includes('\n') || str.includes('\r')) {
                return `"${str.replace(/"/g, '""')}"`;
              }
              return `"${str}"`;
            };
            
            const csvContent = [
              headers.map(h => `"${h}"`).join(','), // Quote headers too
              ...data.map(row => 
                headers.map(header => {
                  const value = row[header] || '';
                  return escapeCsvValue(value);
                }).join(',')
              )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          const importFromCSV = (event, endpoint, onSuccess) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                console.log(`üìÅ Starting CSV import for ${endpoint}`);
                const csv = e.target.result;
                
                // Enhanced CSV parsing to handle commas and quotes in content
                const parseCSVLine = (line) => {
                  const result = [];
                  let current = '';
                  let inQuotes = false;
                  
                  for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                      if (inQuotes && line[i + 1] === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                      } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                      }
                    } else if (char === ',' && !inQuotes) {
                      // Field separator outside quotes
                      result.push(current.trim());
                      current = '';
                    } else {
                      current += char;
                    }
                  }
                  
                  // Add last field
                  result.push(current.trim());
                  return result;
                };
                
                const lines = csv.split('\n').filter(line => line.trim());
                const headers = parseCSVLine(lines[0]).map(h => h.replace(/^"|"$/g, '').trim());
                
                console.log('üìã CSV Headers:', headers);
                
                const data = lines.slice(1)
                  .map(line => {
                    const values = parseCSVLine(line).map(v => v.replace(/^"|"$/g, '').trim());
                    const obj = {};
                    headers.forEach((header, index) => {
                      obj[header] = values[index] || '';
                    });
                    return obj;
                  });
                
                console.log(`üìä Parsed ${data.length} records from CSV`);
                
                // Debug: Show sample data for notes import
                if (endpoint === '/notes' && data.length > 0) {
                  console.log('üîç Sample Notes record:', {
                    title: data[0].title,
                    contentLength: data[0].content ? data[0].content.length : 0,
                    contentPreview: data[0].content ? data[0].content.substring(0, 100) + '...' : 'No content'
                  });
                }
                
                // Use bulk import endpoint
                const bulkEndpoint = `${endpoint}/bulk`;
                console.log(`üöÄ Calling bulk import: ${bulkEndpoint}`);
                
                const result = await api.call(bulkEndpoint, {
                  method: 'POST',
                  body: JSON.stringify({ data })
                });
                
                console.log(`‚úÖ Bulk import result:`, result);
                
                await loadAllData();
                alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                if (onSuccess) onSuccess();
              } catch (error) {
                console.error('Import error:', error);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`);
              }
            };
            reader.readAsText(file);
          };

          // Form handlers
          const handleHarvestSubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
              setLoading(true);
              // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà
              const totalWeight = parseFloat(formData.get('totalWeight'));
              const pricePerKg = parseFloat(formData.get('pricePerKg'));
              const fallenWeight = parseFloat(formData.get('fallenWeight')) || 0;
              const fallenPricePerKg = parseFloat(formData.get('fallenPricePerKg')) || 0;
              const harvestingCost = parseFloat(formData.get('harvestingCost'));
              
              // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° = (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ √ó ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥) + (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏£‡πà‡∏ß‡∏á √ó ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏£‡πà‡∏ß‡∏á)
              const normalRevenue = totalWeight * pricePerKg;
              const fallenRevenue = fallenWeight * fallenPricePerKg;
              const totalRevenue = normalRevenue + fallenRevenue;
              
              // ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ = ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° - ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô
              const netProfit = totalRevenue - harvestingCost;
              
              const result = await api.call('/harvest', {
                method: 'POST',
                body: JSON.stringify({
                  date: formData.get('date'),
                  total_weight: totalWeight,
                  price_per_kg: pricePerKg,
                  fallen_weight: fallenWeight,
                  fallen_price_per_kg: fallenPricePerKg,
                  total_revenue: totalRevenue,
                  harvesting_cost: harvestingCost,
                  net_profit: netProfit
                })
              });
              
              if (result.error) {
                alert(result.error);
                return;
              }
              
              e.target.reset();
              await loadAllData();
              alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
              console.error('Harvest submit error:', error);
              const errorMessage = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß';
              alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorMessage}`);
            } finally {
              setLoading(false);
            }
          };

          // Edit and Delete functions
          const handleEdit = (item, type) => {
            setEditingItem(item);
            setEditType(type);
            setShowEditModal(true);
          };

          const handleDelete = async (id, type) => {
            if (!window.confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) {
              return;
            }

            try {
              setLoading(true);
              await api.call(`/${type}/${id}`, { method: 'DELETE' });
              await loadAllData();
              alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
              console.error('Delete error:', error);
              const errorMessage = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
              alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorMessage}`);
            } finally {
              setLoading(false);
            }
          };

          const handleUpdate = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
              setLoading(true);
              let data = {};
              
              if (editType === 'harvest') {
                const totalWeight = parseFloat(formData.get('total_weight'));
                const pricePerKg = parseFloat(formData.get('price_per_kg'));
                const fallenWeight = parseFloat(formData.get('fallen_weight')) || 0;
                const fallenPricePerKg = parseFloat(formData.get('fallen_price_per_kg')) || 0;
                const harvestingCost = parseFloat(formData.get('harvesting_cost'));
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡πÑ‡∏£
                const normalRevenue = totalWeight * pricePerKg;
                const fallenRevenue = fallenWeight * fallenPricePerKg;
                const totalRevenue = normalRevenue + fallenRevenue;
                const netProfit = totalRevenue - harvestingCost;
                
                data = {
                  date: formData.get('date'),
                  total_weight: totalWeight,
                  price_per_kg: pricePerKg,
                  fallen_weight: fallenWeight,
                  fallen_price_per_kg: fallenPricePerKg,
                  harvesting_cost: harvestingCost
                };
              }
              
              await api.call(`/${editType}/${editingItem.id}`, {
                method: 'PUT',
                body: JSON.stringify(data)
              });
              
              setShowEditModal(false);
              setEditingItem(null);
              await loadAllData();
              alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            } finally {
              setLoading(false);
            }
          };

          // Simulated Gemini AI responses
          const getAIResponse = (message) => {
            const lowerMsg = message.toLowerCase();
            
            if (lowerMsg.includes('hello') || lowerMsg.includes('hi') || lowerMsg.includes('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ')) {
              return "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏° ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?";
            }
            
            if (lowerMsg.includes('‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å') || lowerMsg.includes('user') || lowerMsg.includes('member')) {
              const totalUsers = users.length;
              const activeUsers = users.filter(u => u.is_active).length;
              const adminUsers = users.filter(u => u.role === 'admin').length;
              return `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalUsers} ‡∏Ñ‡∏ô ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ${activeUsers} ‡∏Ñ‡∏ô ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö ${adminUsers} ‡∏Ñ‡∏ô`;
            }
            
            if (lowerMsg.includes('revenue') || lowerMsg.includes('income') || lowerMsg.includes('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ')) {
              const totalRevenue = stats.harvest?.revenue || 0;
              const totalCount = stats.harvest?.count || 0;
              return `‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß ${totalCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
            }
            
            if (lowerMsg.includes('profit') || lowerMsg.includes('earnings') || lowerMsg.includes('‡∏Å‡∏≥‡πÑ‡∏£')) {
              const totalProfit = stats.harvest?.profit || 0;
              return `‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏£‡∏ß‡∏° ${totalProfit.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            }
            
            if (lowerMsg.includes('fertilizer') || lowerMsg.includes('cost') || lowerMsg.includes('‡∏õ‡∏∏‡πã‡∏¢')) {
              const totalCost = stats.fertilizer?.cost || 0;
              const totalCount = stats.fertilizer?.count || 0;
              return `‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏∏‡πã‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${totalCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${totalCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
            }
            
            if (lowerMsg.includes('trees') || lowerMsg.includes('palm') || lowerMsg.includes('‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ')) {
              const treeCount = stats.palmtrees?.count || 0;
              return `‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏° ${treeCount} ‡∏ï‡πâ‡∏ô ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 312 ‡∏ï‡πâ‡∏ô (‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô ${Math.round((treeCount / 312) * 100)}% ‡∏Ç‡∏≠‡∏á‡∏™‡∏ß‡∏ô)`;
            }
            
            return "‡∏ú‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡πÑ‡∏£ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö";
          };

          // Gemini Chat Functions
          const handleGeminiSend = async (e) => {
            e?.preventDefault(); // Handle form submission
            
            if (!geminiInput.trim() || geminiLoading) return;

            const userMessage = { 
              id: Date.now(), 
              text: geminiInput, 
              sender: 'user',
              timestamp: new Date().toISOString()
            };

            setGeminiMessages(prev => [...prev, userMessage]);
            setGeminiInput('');
            setGeminiLoading(true);

            try {
              // Prepare context data with current date information
              const now = new Date();
              const currentDate = now.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
              });
              const currentMonth = now.getMonth() + 1; // 1-12
              const currentYear = now.getFullYear();
              const buddhistYear = currentYear + 543;
              
              const context = {
                // Current date information
                currentDate: currentDate,
                currentDateISO: now.toISOString().split('T')[0], // YYYY-MM-DD
                currentDay: now.getDate(),
                currentMonth: currentMonth,
                currentYear: currentYear,
                buddhistYear: buddhistYear,
                currentTime: now.toLocaleTimeString('th-TH'),
                
                // Business data
                totalRevenue: stats.harvest?.revenue || 0,
                totalProfit: stats.harvest?.profit || 0,
                fertilizerCost: stats.fertilizer?.cost || 0,
                harvestCount: stats.harvest?.count || 0,
                palmTreeCount: stats.palmtrees?.count || 0,
                
                // User information
                userName: currentUser?.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                userEmail: currentUser?.email || ''
              };

              const response = await api.call('/chat', {
                method: 'POST',
                body: JSON.stringify({ 
                  message: userMessage.text,
                  context: context
                })
              });

              const aiMessage = { 
                id: Date.now() + 1, 
                text: response.message, 
                sender: 'ai',
                timestamp: response.timestamp
              };

              setGeminiMessages(prev => [...prev, aiMessage]);
              
              // Auto-speak AI response if voice is supported
              if (voiceSupported && response.message) {
                // Add small delay to ensure message is displayed first
                setTimeout(() => {
                  speakText(response.message);
                }, 500);
              }
            } catch (error) {
              console.error('Gemini chat error:', error);
              
              // Better error handling with more specific messages
              let errorText = '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI';
              
              if (error.response) {
                // Server responded with error status
                const status = error.response.status;
                const data = error.response.data;
                
                if (status === 401) {
                  errorText = 'üîê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                } else if (status === 500) {
                  errorText = '‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á';
                  if (data && data.error) {
                    errorText += `\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${data.error}`;
                  }
                } else if (status === 429) {
                  errorText = '‚è±Ô∏è ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI ‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                } else {
                  errorText = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (${status}): ${data?.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`;
                }
              } else if (error.request) {
                // Network error
                errorText = 'üåê ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
              } else {
                // Other error
                errorText = `üí• ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
              }
              
              const errorMessage = { 
                id: Date.now() + 1, 
                text: errorText, 
                sender: 'ai',
                timestamp: new Date().toISOString()
              };
              setGeminiMessages(prev => [...prev, errorMessage]);
            } finally {
              setGeminiLoading(false);
            }
          };

          // Handle palm tree icon click
          const handleTreeClick = async (treeId) => {
            try {
              setLoading(true);
              const response = await api.call(`/palmtrees/${treeId}/history`);
              setSelectedTreeHistory(response);
              setShowTreeModal(true);
            } catch (error) {
              console.error('Error loading tree history:', error);
              alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°‡πÑ‡∏î‡πâ: ' + error.message);
            } finally {
              setLoading(false);
            }
          };

          // AuthForm Component
          const AuthForm = () => (
            <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 flex items-center justify-center p-4">
              <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                <div className="text-center mb-8">
                  <h1 className="text-3xl font-bold text-green-700">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°</h1>
                  <p className="text-gray-600 mt-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                  <div className="mt-2 text-sm text-blue-600 bg-blue-50 p-2 rounded">
                    üóÑÔ∏è ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SQLite
                  </div>
                </div>

                {/* Tab Switcher */}
                <div className="flex mb-6 border-b">
                  <button
                    onClick={() => setActiveTab('login')}
                    className={`flex-1 py-2 font-medium transition-colors ${
                      activeTab === 'login'
                        ? 'text-green-600 border-b-2 border-green-600'
                        : 'text-gray-500 hover:text-gray-700'
                    }`}
                  >
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
                  <button
                    onClick={() => setActiveTab('signup')}
                    className={`flex-1 py-2 font-medium transition-colors ${
                      activeTab === 'signup'
                        ? 'text-green-600 border-b-2 border-green-600'
                        : 'text-gray-500 hover:text-gray-700'
                    }`}
                  >
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                  </button>
                </div>

                {/* Login Form */}
                {activeTab === 'login' && (
                  <form onSubmit={(e) => { e.preventDefault(); handleLogin(e.target.email.value, e.target.password.value); }} className="space-y-6">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                      <input
                        type="email"
                        name="email"
                        required
                        disabled={loading}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:opacity-50"
                        placeholder="your@email.com"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                      <input
                        type="password"
                        name="password"
                        required
                        disabled={loading}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:opacity-50"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      />
                    </div>
                    <button
                      type="submit"
                      disabled={loading}
                      className="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 rounded-lg transition-colors disabled:opacity-50"
                    >
                      {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
                    </button>
                  </form>
                )}

                {/* Signup Form */}
                {activeTab === 'signup' && (
                  <form onSubmit={(e) => { e.preventDefault(); handleSignup(e.target.username.value, e.target.email.value, e.target.password.value); }} className="space-y-6">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                      <input
                        type="text"
                        name="username"
                        required
                        disabled={loading}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:opacity-50"
                        placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                      <input
                        type="email"
                        name="email"
                        required
                        disabled={loading}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:opacity-50"
                        placeholder="your@email.com"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                      <input
                        type="password"
                        name="password"
                        required
                        minLength="6"
                        disabled={loading}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:opacity-50"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      />
                    </div>
                    <button
                      type="submit"
                      disabled={loading}
                      className="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 rounded-lg transition-colors disabled:opacity-50"
                    >
                      {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}
                    </button>
                  </form>
                )}

                <div className="mt-6 text-center">
                  <p className="text-sm text-gray-600">
                    ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö: admin@palmoil.com / admin123
                  </p>
                </div>
              </div>
            </div>
          );

          // Dashboard Component
          const Dashboard = () => (
            <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100">
              {/* Header */}
              <header className="bg-white shadow-md">
                <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                  <div>
                    <h1 className="text-2xl font-bold text-green-700">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°</h1>
                    <div className="text-sm text-blue-600">üóÑÔ∏è ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SQLite</div>
                  </div>
                  <div className="flex items-center space-x-4">
                    <span className="text-gray-700">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, {currentUser?.username}</span>
                    <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{currentUser?.role}</span>
                    <button
                      onClick={handleLogout}
                      className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors"
                    >
                      ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                  </div>
                </div>
              </header>

              {/* Navigation Tabs */}
              <nav className="bg-white shadow-sm border-b">
                <div className="container mx-auto px-4">
                  <div className="flex space-x-1 overflow-x-auto pb-2">
                    {[
                      {key: 'dashboard', label: '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î'}, 
                      {key: 'harvest', label: '‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß'}, 
                      {key: 'fertilizer', label: '‡∏õ‡∏∏‡πã‡∏¢'}, 
                      {key: 'palmtrees', label: '‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°'}, 
                      {key: 'notes', label: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}, 
                      {key: 'search', label: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}, 
                      {key: 'reports', label: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'},
                      ...(currentUser?.role === 'admin' ? [{key: 'users', label: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}] : [])
                    ].map((tab) => (
                      <button
                        key={tab.key}
                        onClick={() => setActiveTab(tab.key)}
                        className={`px-6 py-3 whitespace-nowrap font-medium text-sm transition-colors ${
                          activeTab === tab.key
                            ? 'bg-green-500 text-white'
                            : 'text-gray-600 hover:text-green-600 hover:bg-gray-50'
                        }`}
                      >
                        {tab.label}
                      </button>
                    ))}
                  </div>
                </div>
              </nav>

              {/* Loading Indicator */}
              {loading && (
                <div className="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white p-6 rounded-lg">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto"></div>
                    <p className="mt-2 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                  </div>
                </div>
              )}

              {/* Main Content */}
              <main className="container mx-auto px-4 py-8">
                {/* Dashboard View */}
                {activeTab === 'dashboard' && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                        <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</h3>
                        <p className="text-3xl font-bold text-green-600">
                          {(stats.harvest?.revenue || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó
                        </p>
                        <p className="text-sm text-gray-500 mt-2">{stats.harvest?.count || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</p>
                      </div>
                      
                      <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                        <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h3>
                        <p className="text-3xl font-bold text-blue-600">
                          {(stats.harvest?.profit || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó
                        </p>
                        <p className="text-sm text-gray-500 mt-2">‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô</p>
                      </div>
                      
                      <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                        <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢</h3>
                        <p className="text-3xl font-bold text-purple-600">
                          {(stats.fertilizer?.cost || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó
                        </p>
                        <p className="text-sm text-gray-500 mt-2">{stats.fertilizer?.count || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                      </div>
                      
                      <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-orange-500">
                        <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°</h3>
                        <p className="text-3xl font-bold text-orange-600">
                          {stats.palmtrees?.count || 0}/{palmTrees.length}
                        </p>
                        <p className="text-sm text-gray-500 mt-2">‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß</p>
                      </div>
                    </div>

                    {/* Admin Stats */}
                    {currentUser?.role === 'admin' && stats.users && (
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-indigo-500">
                          <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                          <p className="text-3xl font-bold text-indigo-600">{stats.users.total}</p>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                          <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                          <p className="text-3xl font-bold text-green-600">{stats.users.active}</p>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Harvest Form */}
                {activeTab === 'harvest' && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</h2>
                    
                    {/* Add Harvest Form */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <h3 className="text-xl font-semibold text-gray-800 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</h3>
                      <form onSubmit={handleHarvestSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                          <input type="date" name="date" required disabled={loading} className="w-full p-2 border border-gray-300 rounded-lg disabled:opacity-50" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏Å‡∏Å.)</label>
                          <input type="number" name="totalWeight" step="0.1" min="0" required disabled={loading} className="w-full p-2 border border-gray-300 rounded-lg disabled:opacity-50" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                          <input type="number" name="pricePerKg" step="0.01" min="0" required disabled={loading} className="w-full p-2 border border-gray-300 rounded-lg disabled:opacity-50" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏£‡πà‡∏ß‡∏á (‡∏Å‡∏Å.)</label>
                          <input type="number" name="fallenWeight" step="0.1" min="0" defaultValue="0" disabled={loading} className="w-full p-2 border border-gray-300 rounded-lg disabled:opacity-50" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏£‡πà‡∏ß‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                          <input type="number" name="fallenPricePerKg" step="0.01" min="0" defaultValue="0" disabled={loading} className="w-full p-2 border border-gray-300 rounded-lg disabled:opacity-50" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (‡∏ö‡∏≤‡∏ó)</label>
                          <input type="number" name="harvestingCost" step="0.01" min="0" required disabled={loading} className="w-full p-2 border border-gray-300 rounded-lg disabled:opacity-50" />
                        </div>
                        <div className="md:col-span-2 lg:col-span-3">
                          <button type="submit" disabled={loading} className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50">
                            {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß'}
                          </button>
                        </div>
                      </form>
                    </div>

                    {/* Harvest Data Table */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß ({harvestData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
                        <div className="flex gap-2">
                          <input
                            type="file"
                            accept=".csv"
                            onChange={(e) => importFromCSV(e, '/harvest', () => e.target.value = '')}
                            className="hidden"
                            id="harvest-import"
                          />
                          <label htmlFor="harvest-import" className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors">
                            üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
                          </label>
                          <button
                            onClick={() => exportToCSV(harvestData, 'harvest_data', ['date', 'total_weight', 'price_per_kg', 'fallen_weight', 'fallen_price_per_kg', 'total_revenue', 'harvesting_cost', 'net_profit'])}
                            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                          >
                            üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                          </button>
                          
                          {/* Debug info */}
                          {currentUser && (
                            <div className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                              User: {currentUser.email} | Role: {currentUser.role} | Data: {harvestData.length}
                            </div>
                          )}
                          
                          {harvestData.length > 0 && (
                            <button
                              onClick={async () => {
                                console.log('üóëÔ∏è Delete All button clicked');
                                console.log('Current user:', currentUser);
                                console.log('Harvest data length:', harvestData.length);
                                
                                if (confirm(`‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${harvestData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!`)) {
                                  try {
                                    setLoading(true);
                                    console.log('üî• Calling delete-all API...');
                                    const result = await api.call('/harvest/delete-all', { method: 'DELETE' });
                                    console.log('‚úÖ Delete all result:', result);
                                    await loadAllData();
                                    alert('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                                  } catch (error) {
                                    console.error('‚ùå Delete all error:', error);
                                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                                  } finally {
                                    setLoading(false);
                                  }
                                }
                              }}
                              disabled={loading}
                              className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                              üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                          )}
                        </div>
                      </div>
                      <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                          <thead>
                            <tr>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                  onClick={() => {
                                    const sorted = [...harvestData].sort((a, b) => 
                                      harvestSortOrder === 'desc' 
                                        ? parseDateForSorting(a.date) - parseDateForSorting(b.date)
                                        : parseDateForSorting(b.date) - parseDateForSorting(a.date)
                                    );
                                    setHarvestData(sorted);
                                    setHarvestSortOrder(harvestSortOrder === 'desc' ? 'asc' : 'desc');
                                  }}>
                                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {harvestSortOrder === 'desc' ? '‚Üì' : '‚Üë'}
                              </th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏£‡πà‡∏ß‡∏á (‡∏Å‡∏Å.)</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡πà‡∏ß‡∏á/‡∏Å‡∏Å.</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                            {harvestData.length > 0 ? (
                              harvestData.map((item) => (
                                <tr key={item.id} className="hover:bg-gray-50">
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatDate(item.date)}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{parseFloat(item.total_weight).toFixed(1)}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{parseFloat(item.price_per_kg).toFixed(2)}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-orange-600">{parseFloat(item.fallen_weight || 0).toFixed(1)}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-orange-600">{parseFloat(item.fallen_price_per_kg || 0).toFixed(2)}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">{parseFloat(item.total_revenue).toLocaleString()}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">{parseFloat(item.harvesting_cost).toLocaleString()}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">{parseFloat(item.net_profit).toLocaleString()}</td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div className="flex space-x-2">
                                      <button
                                        onClick={() => handleEdit(item, 'harvest')}
                                        className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-colors"
                                        disabled={loading}
                                      >
                                        ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                      </button>
                                      <button
                                        onClick={() => handleDelete(item.id, 'harvest')}
                                        className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-colors"
                                        disabled={loading}
                                      >
                                        üóëÔ∏è ‡∏•‡∏ö
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              ))
                            ) : (
                              <tr>
                                <td colSpan="9" className="px-6 py-4 text-center text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</td>
                              </tr>
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* Edit Modal */}
                    {showEditModal && editType === 'harvest' && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                          <h3 className="text-xl font-semibold text-gray-800 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</h3>
                          <form onSubmit={handleUpdate} className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                              <input 
                                type="date" 
                                name="date" 
                                defaultValue={formatDateForInput(editingItem?.date)} 
                                required 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏Å‡∏Å.)</label>
                              <input 
                                type="number" 
                                name="total_weight" 
                                step="0.1" 
                                min="0" 
                                defaultValue={editingItem?.total_weight} 
                                required 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                              <input 
                                type="number" 
                                name="price_per_kg" 
                                step="0.01" 
                                min="0" 
                                defaultValue={editingItem?.price_per_kg} 
                                required 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏£‡πà‡∏ß‡∏á (‡∏Å‡∏Å.)</label>
                              <input 
                                type="number" 
                                name="fallen_weight" 
                                step="0.1" 
                                min="0" 
                                defaultValue={editingItem?.fallen_weight || 0} 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏£‡πà‡∏ß‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                              <input 
                                type="number" 
                                name="fallen_price_per_kg" 
                                step="0.01" 
                                min="0" 
                                defaultValue={editingItem?.fallen_price_per_kg || 0} 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (‡∏ö‡∏≤‡∏ó)</label>
                              <input 
                                type="number" 
                                name="harvesting_cost" 
                                step="0.01" 
                                min="0" 
                                defaultValue={editingItem?.harvesting_cost} 
                                required 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div className="flex gap-4 pt-4">
                              <button 
                                type="submit" 
                                disabled={loading}
                                className="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors disabled:opacity-50"
                              >
                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'}
                              </button>
                              <button 
                                type="button" 
                                onClick={() => {
                                  setShowEditModal(false);
                                  setEditingItem(null);
                                }}
                                className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                              >
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* User Management View - Admin Only */}
                {activeTab === 'users' && currentUser?.role === 'admin' && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                    
                    {/* User Statistics */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                        <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <p className="text-3xl font-bold text-blue-600">{users.length}</p>
                      </div>
                      <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                        <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                        <p className="text-3xl font-bold text-green-600">
                          {users.filter(u => u.is_active).length}
                        </p>
                      </div>
                      <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-orange-500">
                        <h3 className="text-lg font-semibold text-gray-700 mb-2">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <p className="text-3xl font-bold text-orange-600">
                          {users.filter(u => u.role === 'admin').length}
                        </p>
                      </div>
                    </div>

                    {/* Users Table */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <h3 className="text-xl font-semibold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                      <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                          <thead>
                            <tr>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                            {users.map((user) => (
                              <tr key={user.id} className="hover:bg-gray-50">
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                  {user.username}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  {user.email}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  <select
                                    value={user.role}
                                    onChange={(e) => handleUserRoleChange(user.id, e.target.value)}
                                    disabled={user.id === currentUser.id || loading}
                                    className="border border-gray-300 rounded px-2 py-1 text-sm disabled:opacity-50"
                                  >
                                    <option value="user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</option>
                                    <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                                  </select>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  {user.created_at?.split('T')[0] || 'N/A'}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  <span className={`px-2 py-1 rounded-full text-xs ${
                                    user.is_active 
                                      ? 'bg-green-100 text-green-800' 
                                      : 'bg-red-100 text-red-800'
                                  }`}>
                                    {user.is_active ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏£‡∏∞‡∏á‡∏±‡∏ö'}
                                  </span>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                  <button
                                    onClick={() => setEditingUser(user)}
                                    className="px-3 py-1 rounded text-xs font-medium bg-blue-500 text-white hover:bg-blue-600"
                                  >
                                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                  </button>
                                  <button
                                    onClick={() => handleUserToggle(user.id)}
                                    disabled={user.id === currentUser.id || loading}
                                    className={`px-3 py-1 rounded text-xs font-medium ${
                                      user.is_active
                                        ? 'bg-yellow-500 text-white hover:bg-yellow-600'
                                        : 'bg-green-500 text-white hover:bg-green-600'
                                    } disabled:opacity-50 disabled:cursor-not-allowed`}
                                  >
                                    {user.is_active ? '‡∏£‡∏∞‡∏á‡∏±‡∏ö' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ'}
                                  </button>
                                  <button
                                    onClick={() => handleUserDelete(user.id)}
                                    disabled={user.id === currentUser.id || loading}
                                    className="px-3 py-1 rounded text-xs font-medium bg-red-500 text-white hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                  >
                                    ‡∏•‡∏ö
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {/* Edit User Modal */}
                {editingUser && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                      <h3 className="text-lg font-semibold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                      <form onSubmit={async (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const data = {
                          username: formData.get('username'),
                          email: formData.get('email'),
                          role: formData.get('role'),
                          is_active: formData.get('is_active') === 'true'
                        };
                        
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å
                        const password = formData.get('password');
                        if (password && password.trim() !== '') {
                          data.password = password;
                        }
                        
                        try {
                          setLoading(true);
                          await api.call(`/users/${editingUser.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                          });
                          setEditingUser(null);
                          await loadAllData();
                          alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        } catch (error) {
                          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
                        } finally {
                          setLoading(false);
                        }
                      }} className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                          <input 
                            type="text" 
                            name="username" 
                            defaultValue={editingUser.username} 
                            required 
                            className="w-full p-2 border border-gray-300 rounded-lg" 
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                          <input 
                            type="email" 
                            name="email" 
                            defaultValue={editingUser.email} 
                            required 
                            className="w-full p-2 border border-gray-300 rounded-lg" 
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                          <input 
                            type="password" 
                            name="password" 
                            placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)" 
                            className="w-full p-2 border border-gray-300 rounded-lg" 
                          />
                          <p className="text-xs text-gray-500 mt-1">
                            ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                          </p>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                          <select 
                            name="role" 
                            defaultValue={editingUser.role} 
                            required 
                            className="w-full p-2 border border-gray-300 rounded-lg"
                          >
                            <option value="user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</option>
                            <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                          <select 
                            name="is_active" 
                            defaultValue={editingUser.is_active.toString()} 
                            required 
                            className="w-full p-2 border border-gray-300 rounded-lg"
                          >
                            <option value="true">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                            <option value="false">‡∏£‡∏∞‡∏á‡∏±‡∏ö</option>
                          </select>
                        </div>
                        <div className="flex gap-3 pt-4">
                          <button
                            type="submit"
                            disabled={loading}
                            className="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 disabled:opacity-50"
                          >
                            {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}
                          </button>
                          <button
                            type="button"
                            onClick={() => setEditingUser(null)}
                            className="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600"
                          >
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                )}

                {/* Fertilizer Tab */}
                {activeTab === 'fertilizer' && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">‡∏õ‡∏∏‡πã‡∏¢</h2>
                    
                    {/* Add Fertilizer Form */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <h3 className="text-xl font-semibold text-gray-800 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏∏‡πã‡∏¢</h3>
                      <form onSubmit={async (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const data = {
                          date: formData.get('date'),
                          item: formData.get('fertilizer_type'),
                          sacks: parseFloat(formData.get('amount')),
                          price_per_sack: parseFloat(formData.get('cost_per_bag')),
                          labor_cost: parseFloat(formData.get('labor_cost')) || 0
                        };
                        try {
                          await api.call('/fertilizer', { method: 'POST', body: JSON.stringify(data) });
                          await loadAllData();
                          e.target.reset();
                          alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        } catch (error) {
                          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                        }
                      }} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                          <input type="date" name="date" required className="w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏∏‡πã‡∏¢</label>
                          <input type="text" name="fertilizer_type" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ 15-15-15" className="w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)</label>
                          <input type="number" name="amount" step="1" min="0" required className="w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö (‡∏ö‡∏≤‡∏ó)</label>
                          <input type="number" name="cost_per_bag" step="0.01" min="0" required className="w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏´‡∏ß‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πã‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                          <input type="number" name="labor_cost" step="0.01" min="0" placeholder="0" className="w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                          <input type="text" name="supplier" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" className="w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                          <input type="text" name="notes" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" className="w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div className="md:col-span-2 lg:col-span-3">
                          <button type="submit" className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏∏‡πã‡∏¢
                          </button>
                        </div>
                      </form>
                    </div>

                    {/* Fertilizer Data Table */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏∏‡πã‡∏¢ ({fertilizerData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
                        <div className="flex gap-2">
                          <input
                            type="file"
                            accept=".csv"
                            onChange={(e) => importFromCSV(e, '/fertilizer', () => e.target.value = '')}
                            className="hidden"
                            id="fertilizer-import"
                          />
                          <label htmlFor="fertilizer-import" className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors">
                            üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
                          </label>
                          <button
                            onClick={() => exportToCSV(fertilizerData, 'fertilizer_data', ['date', 'fertilizer_type', 'amount', 'cost_per_bag', 'total_cost', 'supplier', 'notes', 'created_at'])}
                            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                          >
                            üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                          </button>
                        </div>
                      </div>
                      <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                          <thead>
                            <tr>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                  onClick={() => {
                                    const sorted = [...fertilizerData].sort((a, b) => 
                                      fertilizerSortOrder === 'desc' 
                                        ? parseDateForSorting(a.date) - parseDateForSorting(b.date)
                                        : parseDateForSorting(b.date) - parseDateForSorting(a.date)
                                    );
                                    setFertilizerData(sorted);
                                    setFertilizerSortOrder(fertilizerSortOrder === 'desc' ? 'asc' : 'desc');
                                  }}>
                                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {fertilizerSortOrder === 'desc' ? '‚Üì' : '‚Üë'}
                              </th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏∏‡πã‡∏¢</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                            {fertilizerData.length === 0 ? (
                              <tr>
                                <td colSpan="8" className="px-6 py-8 text-center text-gray-500">
                                  ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏∏‡πã‡∏¢
                                </td>
                              </tr>
                            ) : fertilizerData.map((item) => (
                              <tr key={item.id} className="hover:bg-gray-50">
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  {formatDate(item.date)}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  {item.fertilizer_type}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  {item.amount} ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  ‡∏ø{item.cost_per_bag?.toLocaleString()}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-orange-600">
                                  ‡∏ø{(item.labor_cost || 0).toLocaleString()}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">
                                  ‡∏ø{item.total_cost?.toLocaleString()}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  {item.supplier || '-'}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  <div className="flex space-x-2">
                                    <button
                                      onClick={() => handleEdit(item, 'fertilizer')}
                                      className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-colors"
                                      disabled={loading}
                                    >
                                      ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                    </button>
                                    <button
                                      onClick={() => handleDelete(item.id, 'fertilizer')}
                                      className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-colors"
                                      disabled={loading}
                                    >
                                      üóëÔ∏è ‡∏•‡∏ö
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* Edit Modal for Fertilizer */}
                    {showEditModal && editType === 'fertilizer' && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                          <h3 className="text-xl font-semibold text-gray-800 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏∏‡πã‡∏¢</h3>
                          <form onSubmit={async (e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            const data = {
                              date: formData.get('date'),
                              fertilizer_type: formData.get('fertilizer_type'),
                              amount: parseInt(formData.get('amount')),
                              cost_per_bag: parseFloat(formData.get('cost_per_bag')),
                              labor_cost: parseFloat(formData.get('labor_cost')) || 0,
                              supplier: formData.get('supplier') || '',
                              notes: formData.get('notes') || ''
                            };
                            try {
                              setLoading(true);
                              await api.call(`/fertilizer/${editingItem.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                              });
                              setShowEditModal(false);
                              setEditingItem(null);
                              await loadAllData();
                              alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            } catch (error) {
                              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                            } finally {
                              setLoading(false);
                            }
                          }} className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                              <input 
                                type="date" 
                                name="date" 
                                defaultValue={formatDateForInput(editingItem?.date)} 
                                required 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏∏‡πã‡∏¢</label>
                              <input 
                                type="text" 
                                name="fertilizer_type" 
                                defaultValue={editingItem?.fertilizer_type} 
                                required 
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ 15-15-15"
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)</label>
                              <input 
                                type="number" 
                                name="amount" 
                                step="1" 
                                min="0" 
                                defaultValue={editingItem?.amount} 
                                required 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö (‡∏ö‡∏≤‡∏ó)</label>
                              <input 
                                type="number" 
                                name="cost_per_bag" 
                                step="0.01" 
                                min="0" 
                                defaultValue={editingItem?.cost_per_bag} 
                                required 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏´‡∏ß‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πã‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                              <input 
                                type="number" 
                                name="labor_cost" 
                                step="0.01" 
                                min="0" 
                                defaultValue={editingItem?.labor_cost || 0} 
                                placeholder="0"
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                              <input 
                                type="text" 
                                name="supplier" 
                                defaultValue={editingItem?.supplier || ''} 
                                placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó"
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                              <input 
                                type="text" 
                                name="notes" 
                                defaultValue={editingItem?.notes || ''} 
                                placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div className="flex gap-4 pt-4">
                              <button 
                                type="submit" 
                                disabled={loading}
                                className="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors disabled:opacity-50"
                              >
                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'}
                              </button>
                              <button 
                                type="button" 
                                onClick={() => {
                                  setShowEditModal(false);
                                  setEditingItem(null);
                                }}
                                className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                              >
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Palm Trees Tab */}
                {activeTab === 'palmtrees' && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°</h2>
                    
                    {/* Add Palm Tree Form */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <h3 className="text-xl font-semibold text-gray-800 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°</h3>
                      
                      {/* Tree Selection Grid */}
                      <div className="mb-6">
                        <label className="block text-sm font-medium text-gray-700 mb-3">1. ‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô 312 ‡∏ï‡πâ‡∏ô)</label>
                        <div className="grid grid-cols-12 gap-1 p-4 bg-gray-50 rounded-lg max-h-64 overflow-y-auto border-2 border-green-200">
                          {palmTrees.map((treeId) => (
                            <button
                              key={treeId}
                              type="button"
                              onClick={() => setSelectedTreeId(treeId)}
                              className={`w-10 h-10 text-xs font-medium rounded border-2 transition-all duration-200 ${
                                selectedTreeId === treeId 
                                  ? 'bg-green-500 text-white border-green-600 transform scale-110 shadow-lg' 
                                  : 'bg-white text-gray-700 border-gray-300 hover:border-green-400 hover:bg-green-50 hover:shadow-md'
                              }`}
                              title={`‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏° ${treeId}`}
                            >
                              üå¥
                              <br />
                              <span className="text-xs">{treeId}</span>
                            </button>
                          ))}
                        </div>
                        {selectedTreeId && (
                          <p className="mt-2 text-sm text-green-600 font-medium bg-green-50 p-2 rounded">
                            ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ: {selectedTreeId}
                          </p>
                        )}
                      </div>

                      <form onSubmit={async (e) => {
                        e.preventDefault();
                        
                        if (!selectedTreeId) {
                          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ');
                          return;
                        }
                        
                        const formData = new FormData(e.target);
                        const data = {
                          palm_tree: selectedTreeId,
                          date: formData.get('harvest_date'),
                          bunches: parseInt(formData.get('bunch_count')),
                          notes: formData.get('notes') || ''
                        };
                        
                        try {
                          await api.call('/palmtrees', { method: 'POST', body: JSON.stringify(data) });
                          await loadAllData();
                          e.target.reset();
                          setSelectedTreeId('');
                          alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        } catch (error) {
                          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                        }
                      }} className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">2. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß *</label>
                          <input 
                            type="date" 
                            name="harvest_date" 
                            required 
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">3. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß *</label>
                          <input 
                            type="number" 
                            name="bunch_count" 
                            min="0" 
                            step="1" 
                            required 
                            placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">4. ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                          <input 
                            type="text" 
                            name="notes" 
                            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                          />
                        </div>
                        
                        <div className="md:col-span-3">
                          <button 
                            type="submit" 
                            disabled={!selectedTreeId}
                            className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-8 py-3 rounded-lg transition-colors font-medium shadow-md"
                          >
                            {!selectedTreeId ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏Å‡πà‡∏≠‡∏ô' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß'}
                          </button>
                        </div>
                      </form>
                    </div>

                    {/* Palm Trees Data Table */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏° ({palmTreeData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
                        <div className="flex gap-2">
                          <input
                            type="file"
                            accept=".csv"
                            onChange={(e) => importFromCSV(e, '/palmtrees', () => e.target.value = '')}
                            className="hidden"
                            id="palmtree-import"
                          />
                          <label htmlFor="palmtree-import" className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors">
                            üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
                          </label>
                          <button
                            onClick={() => exportToCSV(palmTreeData, 'palmtree_harvest_data', ['tree_id', 'harvest_date', 'bunch_count', 'notes', 'created_at'])}
                            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                          >
                            üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                          </button>
                          {palmTreeData.length > 0 && (
                            <button
                              onClick={async () => {
                                console.log('üóëÔ∏è Delete All Palm Trees button clicked');
                                console.log('Current user:', currentUser);
                                console.log('Palm tree data length:', palmTreeData.length);
                                
                                if (confirm(`‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${palmTreeData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!`)) {
                                  try {
                                    setLoading(true);
                                    console.log('üî• Calling palmtrees/all delete API...');
                                    const result = await api.call('/palmtrees/all', { method: 'DELETE' });
                                    console.log('‚úÖ Delete all palm trees result:', result);
                                    await loadAllData();
                                    alert('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                                  } catch (error) {
                                    console.error('‚ùå Delete all palm trees error:', error);
                                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                                  } finally {
                                    setLoading(false);
                                  }
                                }
                              }}
                              className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors"
                              disabled={loading}
                            >
                              üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                          )}
                        </div>
                      </div>
                      <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                          <thead>
                            <tr>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                  onClick={() => {
                                    const sorted = [...palmTreeData].sort((a, b) => 
                                      palmTreeSortOrder === 'desc' 
                                        ? parseDateForSorting(a.date || a.harvest_date) - parseDateForSorting(b.date || b.harvest_date)
                                        : parseDateForSorting(b.date || b.harvest_date) - parseDateForSorting(a.date || a.harvest_date)
                                    );
                                    setPalmTreeData(sorted);
                                    setPalmTreeSortOrder(palmTreeSortOrder === 'desc' ? 'asc' : 'desc');
                                  }}>
                                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß {palmTreeSortOrder === 'desc' ? '‚Üì' : '‚Üë'}
                              </th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                            {palmTreeData.length === 0 ? (
                              <tr>
                                <td colSpan="6" className="px-6 py-8 text-center text-gray-500">
                                  ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°
                                </td>
                              </tr>
                              ) : palmTreeData.map((record, idx) => (
                                <tr key={record.id || idx} className="hover:bg-gray-50">
                                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">
                                      üå¥ {record.palm_tree || record.tree_id}
                                    </span>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {record.date ? formatDate(record.date) : record.harvest_date ? formatDate(record.harvest_date) : '-'}
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded font-medium">
                                      {(record.bunches || record.bunch_count) + ' ‡∏ó‡∏∞‡∏•‡∏≤‡∏¢'}
                                    </span>
                                  </td>
                                  <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
                                    {record.notes || '-'}
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {record.created_at ? formatDate(record.created_at) : '-'}
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div className="flex space-x-2">
                                      <button
                                        onClick={() => handleEdit(record, 'palmtrees')}
                                        className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-colors"
                                        disabled={loading}
                                      >
                                        ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                      </button>
                                      <button
                                        onClick={() => handleDelete(record.id, 'palmtrees')}
                                        className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-colors"
                                        disabled={loading}
                                      >
                                        üóëÔ∏è ‡∏•‡∏ö
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              ))}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* Edit Modal for Palm Trees */}
                    {showEditModal && editType === 'palmtrees' && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white p-6 rounded-xl shadow-xl max-w-md w-full mx-4">
                          <h3 className="text-xl font-semibold text-gray-800 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°</h3>
                          
                          {/* Tree Selection for Edit */}
                          <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ</label>
                            <div className="grid grid-cols-8 gap-1 p-3 bg-gray-50 rounded-lg max-h-32 overflow-y-auto border">
                              {palmTrees.map((treeId) => (
                                <button
                                  key={treeId}
                                  type="button"
                                  onClick={() => setSelectedTreeId(treeId)}
                                  className={`w-8 h-8 text-xs font-medium rounded border transition-all ${
                                    (selectedTreeId || editingItem?.palm_tree || editingItem?.tree_id) === treeId 
                                      ? 'bg-green-500 text-white border-green-600' 
                                      : 'bg-white text-gray-700 border-gray-300 hover:border-green-400'
                                  }`}
                                >
                                  {treeId}
                                </button>
                              ))}
                            </div>
                            <p className="mt-1 text-sm text-green-600">
                              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {selectedTreeId || editingItem?.palm_tree || editingItem?.tree_id}
                            </p>
                          </div>
                          
                          <form onSubmit={async (e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            const data = {
                              palm_tree: selectedTreeId || editingItem?.palm_tree || editingItem?.tree_id,
                              date: formData.get('harvest_date'),
                              bunches: parseInt(formData.get('bunch_count')),
                              notes: formData.get('notes') || ''
                            };
                            try {
                              setLoading(true);
                              await api.call(`/palmtrees/${editingItem.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                              });
                              setShowEditModal(false);
                              setEditingItem(null);
                              setSelectedTreeId('');
                              await loadAllData();
                              alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            } catch (error) {
                              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                            } finally {
                              setLoading(false);
                            }
                          }} className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</label>
                              <input 
                                type="date" 
                                name="harvest_date" 
                                defaultValue={formatDateForInput(editingItem?.date || editingItem?.harvest_date)} 
                                required 
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢</label>
                              <input 
                                type="number" 
                                name="bunch_count" 
                                step="1" 
                                min="0" 
                                defaultValue={editingItem?.bunches || editingItem?.bunch_count} 
                                required 
                                placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢"
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                              <input 
                                type="text" 
                                name="notes" 
                                defaultValue={editingItem?.notes || ''} 
                                placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div className="flex gap-4 pt-4">
                              <button 
                                type="submit" 
                                disabled={loading}
                                className="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors disabled:opacity-50"
                              >
                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'}
                              </button>
                              <button 
                                type="button" 
                                onClick={() => {
                                  setShowEditModal(false);
                                  setEditingItem(null);
                                  setSelectedTreeId('');
                                }}
                                className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                              >
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Notes Tab */}
                {activeTab === 'notes' && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
                    
                    {/* Add Note Form */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <h3 className="text-xl font-semibold text-gray-800 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
                      <form onSubmit={async (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const data = {
                          date: formData.get('date'),
                          title: formData.get('title'),
                          content: formData.get('content')
                        };
                        try {
                          await api.call('/notes', { method: 'POST', body: JSON.stringify(data) });
                          await loadAllData();
                          e.target.reset();
                          alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        } catch (error) {
                          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                        }
                      }} className="space-y-4">
                        <div className="grid grid-cols-1 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" name="date" required className="w-full p-2 border border-gray-300 rounded-lg" />
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
                          <input type="text" name="title" required placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" className="w-full p-2 border border-gray-300 rounded-lg" />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label>
                          <textarea 
                            name="content" 
                            rows="8" 
                            required 
                            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß)"
                            className="w-full p-2 border border-gray-300 rounded-lg resize-y min-h-32"
                            onInput={(e) => {
                              e.target.style.height = 'auto';
                              e.target.style.height = Math.max(e.target.scrollHeight, 128) + 'px';
                            }}
                          ></textarea>
                        </div>
                        <div>
                          <button type="submit" className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                          </button>
                        </div>
                      </form>
                    </div>

                    {/* Notes Data Table */}
                    <div className="bg-white p-6 rounded-xl shadow-md">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-semibold text-gray-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({notesData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
                        <div className="flex gap-2 items-center">
                          <button
                            onClick={() => {
                              const sorted = [...notesData].sort((a, b) => 
                                notesSortOrder === 'desc' 
                                  ? parseDateForSorting(a.date) - parseDateForSorting(b.date)
                                  : parseDateForSorting(b.date) - parseDateForSorting(a.date)
                              );
                              setNotesData(sorted);
                              setNotesSortOrder(notesSortOrder === 'desc' ? 'asc' : 'desc');
                            }}
                            className="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition-colors text-sm"
                            title="‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"
                          >
                            üìÖ {notesSortOrder === 'desc' ? '‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î' : '‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î'}
                          </button>
                          <input
                            type="file"
                            accept=".csv"
                            onChange={(e) => importFromCSV(e, '/notes', () => e.target.value = '')}
                            className="hidden"
                            id="notes-import"
                          />
                          <label htmlFor="notes-import" className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors">
                            üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
                          </label>
                          <button
                            onClick={() => exportToCSV(notesData, 'notes_data', ['date', 'title', 'content', 'created_at'])}
                            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                          >
                            üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                          </button>
                        </div>
                      </div>
                      <div className="space-y-4">
                        {notesData.length === 0 ? (
                          <div className="text-center py-8 text-gray-500">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                          </div>
                        ) : notesData.map((note) => (
                          <div key={note.id} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                            <div className="flex justify-between items-start mb-2">
                              <h4 className="text-lg font-semibold text-gray-800">{note.title}</h4>
                              <div className="flex gap-2 items-center">
                                <div className="flex gap-1 ml-2">
                                  <button
                                    onClick={() => handleEdit(note, 'notes')}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition-colors"
                                    disabled={loading}
                                  >
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                  </button>
                                  <button
                                    onClick={() => handleDelete(note.id, 'notes')}
                                    className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-colors"
                                    disabled={loading}
                                  >
                                    üóëÔ∏è ‡∏•‡∏ö
                                  </button>
                                </div>
                              </div>
                            </div>
                            <div className="text-gray-700 mb-2">
                              {(() => {
                                const isLong = note.content && note.content.length > 200;
                                const isExpanded = expandedNotes[note.id];
                                const displayContent = isLong && !isExpanded 
                                  ? note.content.substring(0, 200) + '...' 
                                  : note.content;

                                return (
                                  <div>
                                    <div className="whitespace-pre-wrap break-words max-w-none">
                                      {displayContent}
                                    </div>
                                    {isLong && (
                                      <button 
                                        onClick={() => setExpandedNotes(prev => ({...prev, [note.id]: !prev[note.id]}))}
                                        className="text-blue-500 hover:text-blue-700 text-sm mt-1 underline"
                                      >
                                        {isExpanded ? '‡∏î‡∏π‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á' : '‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}
                                      </button>
                                    )}
                                  </div>
                                );
                              })()}
                            </div>
                            <div className="text-sm text-gray-500">
                              ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {formatDate(note.date)}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Edit Modal for Notes */}
                    {showEditModal && editType === 'notes' && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white p-6 rounded-xl shadow-xl max-w-lg w-full mx-4">
                          <h3 className="text-xl font-semibold text-gray-800 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
                          <form onSubmit={async (e) => {
                            e.preventDefault();
                            const formData = new FormData(e.target);
                            const data = {
                              date: formData.get('date'),
                              title: formData.get('title'),
                              content: formData.get('content')
                            };
                            try {
                              setLoading(true);
                              await api.call(`/notes/${editingItem.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                              });
                              setShowEditModal(false);
                              setEditingItem(null);
                              await loadAllData();
                              alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            } catch (error) {
                              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                            } finally {
                              setLoading(false);
                            }
                          }} className="space-y-4">
                            <div className="grid grid-cols-1 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input 
                                  type="date" 
                                  name="date" 
                                  defaultValue={formatDateForInput(editingItem?.date)} 
                                  required 
                                  className="w-full p-2 border border-gray-300 rounded-lg" 
                                />
                              </div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
                              <input 
                                type="text" 
                                name="title" 
                                defaultValue={editingItem?.title} 
                                required 
                                placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"
                                className="w-full p-2 border border-gray-300 rounded-lg" 
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</label>
                              <textarea 
                                name="content" 
                                rows="8" 
                                defaultValue={editingItem?.content} 
                                required 
                                placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß)"
                                className="w-full p-2 border border-gray-300 rounded-lg resize-y min-h-32"
                                ref={(textarea) => {
                                  if (textarea && editingItem?.content) {
                                    // Auto-resize on load
                                    setTimeout(() => {
                                      textarea.style.height = 'auto';
                                      textarea.style.height = Math.max(textarea.scrollHeight, 128) + 'px';
                                    }, 0);
                                  }
                                }}
                                onInput={(e) => {
                                  e.target.style.height = 'auto';
                                  e.target.style.height = Math.max(e.target.scrollHeight, 128) + 'px';
                                }}
                              ></textarea>
                            </div>
                            <div className="flex gap-4 pt-4">
                              <button 
                                type="submit" 
                                disabled={loading}
                                className="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors disabled:opacity-50"
                              >
                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'}
                              </button>
                              <button 
                                type="button" 
                                onClick={() => {
                                  setShowEditModal(false);
                                  setEditingItem(null);
                                }}
                                className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                              >
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Search Tab */}
                {activeTab === 'search' && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ AI Assistant</h2>

                    {/* Palm Trees Visualization */}
                    <div className="bg-white p-8 rounded-xl shadow-lg">
                      <h3 className="text-xl font-semibold text-gray-800 mb-6">üå¥ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏° (312 ‡∏ï‡πâ‡∏ô)</h3>
                      
                      {/* Desktop and Tablet View */}
                      <div className="hidden md:block">
                        <div className="grid gap-1 mb-6" style={{gridTemplateColumns: 'repeat(26, minmax(0, 1fr))'}}>
                          {palmTreeList.map((tree) => (
                            <div
                              key={tree.tree_id}
                              onClick={() => handleTreeClick(tree.tree_id)}
                              className={`
                                w-8 h-8 rounded-lg flex items-center justify-center font-bold cursor-pointer transition-all duration-200 hover:scale-110 hover:z-10 relative
                                ${tree.status === 'active' 
                                  ? tree.harvest_count > 5 
                                    ? 'bg-green-600 text-white shadow-md' 
                                    : 'bg-green-400 text-white shadow-sm'
                                  : 'bg-gray-300 text-gray-600 border border-gray-400'
                                }
                              `}
                              style={{fontSize: '8px'}}
                              title={`${tree.tree_id} - ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß ${tree.harvest_count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ‡∏£‡∏ß‡∏° ${tree.total_bunches} ‡∏ó‡∏∞‡∏•‡∏≤‡∏¢`}
                            >
                              {tree.tree_id}
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Mobile View */}
                      <div className="md:hidden">
                        <div className="grid gap-2 mb-6" style={{gridTemplateColumns: 'repeat(13, minmax(0, 1fr))'}}>
                          {palmTreeList.map((tree) => (
                            <div
                              key={tree.tree_id}
                              onClick={() => handleTreeClick(tree.tree_id)}
                              className={`
                                w-12 h-12 rounded-xl flex items-center justify-center font-bold cursor-pointer transition-all duration-200 active:scale-95 relative border-2
                                ${tree.status === 'active' 
                                  ? tree.harvest_count > 5 
                                    ? 'bg-green-600 text-white shadow-lg border-green-700' 
                                    : 'bg-green-400 text-white shadow-md border-green-500'
                                  : 'bg-gray-200 text-gray-700 border-gray-300'
                                }
                              `}
                              style={{fontSize: '10px', lineHeight: '1'}}
                              title={`${tree.tree_id} - ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß ${tree.harvest_count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ‡∏£‡∏ß‡∏° ${tree.total_bunches} ‡∏ó‡∏∞‡∏•‡∏≤‡∏¢`}
                            >
                              <div className="text-center">
                                <div className="font-extrabold">{tree.tree_id}</div>
                                {tree.harvest_count > 0 && (
                                  <div className="text-xs opacity-75">{tree.harvest_count}</div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* Legend - Responsive */}
                      <div className="flex flex-wrap items-center gap-3 text-sm bg-gray-50 p-3 rounded-lg">
                        <div className="flex items-center gap-2">
                          <div className="w-5 h-5 bg-gray-200 border-2 border-gray-300 rounded-lg"></div>
                          <span className="text-gray-700">‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className="w-5 h-5 bg-green-400 border-2 border-green-500 rounded-lg"></div>
                          <span className="text-gray-700">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß 1-5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className="w-5 h-5 bg-green-600 border-2 border-green-700 rounded-lg"></div>
                          <span className="text-gray-700">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                        </div>
                      </div>
                      
                      {/* Mobile Instructions */}
                      <div className="md:hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p className="text-sm text-blue-700">
                          üí° <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏° (‡πÄ‡∏ä‡πà‡∏ô A1, B2) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
                        </p>
                        <p className="text-xs text-blue-600 mt-1">
                          ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏•‡πá‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
                        </p>
                      </div>
                    </div>

                    {/* Search Results */}
                    {searchResults.length > 0 && (
                      <div className="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-green-200">
                        <div className="flex justify-between items-center mb-4">
                          <h3 className="text-lg md:text-xl font-semibold text-gray-800">üí° ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
                          <button
                            onClick={() => setSearchResults([])}
                            className="text-sm px-3 py-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors"
                          >
                            ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                          </button>
                        </div>
                        <div className="space-y-3">
                          {searchResults.map((result, index) => (
                            <div key={index} className="border-l-4 border-green-500 pl-4 py-3 bg-green-50 rounded-r-lg">
                              <div className="flex flex-col md:flex-row md:justify-between md:items-start mb-2">
                                <p className="text-sm text-gray-600 mb-1 md:mb-0">
                                  <strong>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</strong> {result.query}
                                </p>
                                <span className="text-xs text-gray-400">
                                  {new Date(result.timestamp).toLocaleString('th-TH')}
                                </span>
                              </div>
                              <p className="text-gray-800 leading-relaxed">
                                <strong>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:</strong> {result.answer}
                              </p>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Quick Search Examples */}
                    <div className="bg-white p-8 rounded-xl shadow-lg">
                      <h3 className="text-xl font-semibold text-gray-800 mb-6">‚ú® ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {[
                          "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?",
                          "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?",
                          "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà?",
                          "‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
                          "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?",
                          "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà?",
                          "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà",
                          "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà",
                          "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà",
                          "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà"
                        ].map((example, index) => (
                          <button
                            key={index}
                            onClick={async () => {
                              setSearchLoading(true);
                              try {
                                const response = await api.call('/search', {
                                  method: 'POST',
                                  body: JSON.stringify({ question: example })
                                });
                                
                                const newResult = {
                                  query: example,
                                  answer: response.answer,
                                  timestamp: new Date().toISOString()
                                };
                                
                                setSearchResults(prev => [newResult, ...prev]);
                              } catch (error) {
                                console.error('Search error:', error);
                                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + error.message);
                              } finally {
                                setSearchLoading(false);
                              }
                            }}
                            disabled={searchLoading}
                            className="text-left p-3 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            <span className="text-sm text-gray-600">üí¨ </span>
                            <span className="text-gray-800">{example}</span>
                            {searchLoading && (
                              <div className="ml-2 inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-green-500"></div>
                            )}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* Reports Tab */}
                {activeTab === 'reports' && (
                  <div className="space-y-8">
                    <h2 className="text-3xl font-bold text-gray-800">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü</h2>
                    
                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div className="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white">
                        <h3 className="text-lg font-semibold mb-2">üåæ ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</h3>
                        <p className="text-3xl font-bold">{yearlyStats.harvest?.length || 0}</p>
                        <p className="text-sm opacity-90">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                      </div>
                      <div className="bg-gradient-to-r from-purple-500 to-purple-600 p-6 rounded-xl shadow-lg text-white">
                        <h3 className="text-lg font-semibold mb-2">üß™ ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢</h3>
                        <p className="text-3xl font-bold">{yearlyStats.fertilizer?.length || 0}</p>
                        <p className="text-sm opacity-90">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                      </div>
                      <div className="bg-gradient-to-r from-orange-500 to-orange-600 p-6 rounded-xl shadow-lg text-white">
                        <h3 className="text-lg font-semibold mb-2">üå¥ ‡∏õ‡∏µ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°</h3>
                        <p className="text-3xl font-bold">{yearlyStats.palmtrees?.length || 0}</p>
                        <p className="text-sm opacity-90">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                      </div>
                    </div>

                    {/* Monthly Charts Section */}
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                      <h3 className="text-xl font-semibold text-gray-800 mb-6">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</h3>
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        {/* Monthly Revenue and Profit Chart */}
                        <div className="h-80">
                          <canvas id="monthlyRevenueProfitChart"></canvas>
                        </div>

                        {/* Monthly Fertilizer Cost Chart */}
                        <div className="h-80">
                          <canvas id="monthlyFertilizerCostChart"></canvas>
                        </div>

                        {/* Monthly Palm Tree Bunches Chart */}
                        <div className="h-80">
                          <canvas id="monthlyPalmTreeBunchesChart"></canvas>
                        </div>

                        {/* Monthly Harvest Weight Chart */}
                        <div className="h-80">
                          <canvas id="monthlyHarvestWeightChart"></canvas>
                        </div>

                        {/* Monthly Price per KG Chart */}
                        <div className="space-y-4">
                          <div className="flex items-center gap-4">
                            <h4 className="text-lg font-medium text-gray-700">üìä ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                            <select 
                              id="priceChartYearSelect"
                              className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              onChange={(e) => window.updatePriceChart && window.updatePriceChart(parseInt(e.target.value))}
                            >
                              <option value="2025">‡∏õ‡∏µ 2025 (2568)</option>
                              <option value="2024">‡∏õ‡∏µ 2024 (2567)</option>
                              <option value="2023">‡∏õ‡∏µ 2023 (2566)</option>
                              <option value="2022">‡∏õ‡∏µ 2022 (2565)</option>
                              <option value="2021">‡∏õ‡∏µ 2021 (2564)</option>
                              <option value="2020">‡∏õ‡∏µ 2020 (2563)</option>
                            </select>
                          </div>
                          <div className="h-80">
                            <canvas id="monthlyPricePerKgChart"></canvas>
                          </div>
                        </div>

                      </div>
                    </div>

                    {/* Yearly Charts Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      
                      {/* Harvest Revenue Chart */}
                      <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">üìà ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                        <div className="h-80">
                          <canvas id="harvestRevenueChart"></canvas>
                        </div>
                      </div>

                      {/* Harvest Weight Chart */}
                      <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                        <div className="h-80">
                          <canvas id="harvestWeightChart"></canvas>
                        </div>
                      </div>

                      {/* Fertilizer Cost Chart */}
                      <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                        <div className="h-80">
                          <canvas id="fertilizerCostChart"></canvas>
                        </div>
                      </div>

                      {/* Palm Trees Chart */}
                      <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">üå¥ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                        <div className="h-80">
                          <canvas id="palmTreeBunchesChart"></canvas>
                        </div>
                      </div>

                    </div>

                    {/* Profit vs Cost Comparison */}
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                      <h3 className="text-xl font-semibold text-gray-800 mb-4">üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                      <div className="h-96">
                        <canvas id="profitVsCostChart"></canvas>
                      </div>
                    </div>

                    {/* Data Table Summary */}
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                      <h3 className="text-xl font-semibold text-gray-800 mb-4">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3>
                      <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                          <thead className="bg-gray-50">
                            <tr>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏õ‡∏µ</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏Å‡∏Å.)</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢</th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</th>
                            </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                            {(() => {
                              // Combine all years from different data sources
                              const allYears = new Set();
                              yearlyStats.harvest?.forEach(item => allYears.add(item.year));
                              yearlyStats.fertilizer?.forEach(item => allYears.add(item.year));
                              yearlyStats.palmtrees?.forEach(item => allYears.add(item.year));
                              
                              return Array.from(allYears).sort().reverse().map(year => {
                                const harvestData = yearlyStats.harvest?.find(h => h.year === year) || {};
                                const fertilizerData = yearlyStats.fertilizer?.find(f => f.year === year) || {};
                                const palmtreeData = yearlyStats.palmtrees?.find(p => p.year === year) || {};
                                
                                return (
                                  <tr key={year} className="hover:bg-gray-50">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{year}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{harvestData.harvest_count || 0}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">
                                      {(harvestData.total_revenue || 0).toLocaleString()}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">
                                      {(harvestData.total_profit || 0).toLocaleString()}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-purple-600 font-medium">
                                      {(fertilizerData.total_cost || 0).toLocaleString()}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                      {(harvestData.total_weight || 0).toLocaleString()}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-orange-600 font-medium">
                                      {(palmtreeData.total_bunches || 0).toLocaleString()}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">
                                      {palmtreeData.unique_trees || 0} ‡∏ï‡πâ‡∏ô
                                    </td>
                                  </tr>
                                );
                              });
                            })()}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {/* Other tabs show simple message */}
                {!['dashboard', 'harvest', 'fertilizer', 'palmtrees', 'notes', 'search', 'users', 'reports'].includes(activeTab) && (
                  <div className="bg-white p-8 rounded-xl shadow-md text-center">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">‡∏´‡∏ô‡πâ‡∏≤ {activeTab} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤</h2>
                    <p className="text-gray-600">‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>
                  </div>
                )}
              </main>

              {/* AI Assistant Chat Button */}
              {currentUser && (
                <button
                  onClick={() => setShowGeminiChat(!showGeminiChat)}
                  className={`fixed bottom-6 right-6 text-white p-4 rounded-full shadow-lg transition-colors z-50 ${
                    geminiStatus === 'ready' ? 'bg-blue-500 hover:bg-blue-600' :
                    geminiStatus === 'unavailable' ? 'bg-gray-400 cursor-not-allowed' :
                    'bg-yellow-500 hover:bg-yellow-600'
                  }`}
                  title={
                    geminiStatus === 'ready' ? '‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI Assistant (Offline)' :
                    geminiStatus === 'unavailable' ? 'AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' :
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö AI...'
                  }
                  disabled={geminiStatus === 'unavailable'}
                >
                  {geminiStatus === 'ready' ? 'ü§ñ' : 
                   geminiStatus === 'unavailable' ? 'üö´' : '‚è≥'}
                </button>
              )}

              {/* Gemini AI Chat Modal */}
              {showGeminiChat && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl h-full sm:h-3/4 flex flex-col">
                    {/* Chat Header */}
                    <div className="bg-green-600 text-white p-3 sm:p-4 rounded-t-lg flex justify-between items-center">
                      <div>
                        <h3 className="text-base sm:text-lg font-semibold">‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI Assistant (Offline)</h3>
                        <div className="text-xs sm:text-sm opacity-90 flex items-center space-x-2">
                          <span>
                            {geminiStatus === 'ready' && 'üü¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
                            {geminiStatus === 'unavailable' && 'üî¥ ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
                            {geminiStatus === 'unknown' && 'üü° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'}
                          </span>
                          {voiceSupported && (
                            <span className="text-xs bg-green-700 px-2 py-1 rounded">
                              üé§ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°
                            </span>
                          )}
                        </div>
                      </div>
                      <button
                        onClick={() => setShowGeminiChat(false)}
                        className="text-white hover:text-gray-200 text-xl"
                      >
                        ‚úï
                      </button>
                    </div>

                    {/* Chat Messages */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                      {geminiMessages.length === 0 ? (
                        <div className="text-center text-gray-500 py-8">
                          <div className="text-4xl mb-2">ü§ñ</div>
                          <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ Gemini AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                          <p className="text-sm mb-4">‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
                          
                          {/* Example Questions */}
                          <div className="text-left bg-gray-50 rounded-lg p-3 mt-4">
                            <p className="font-medium text-gray-700 mb-2">üí° ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</p>
                            <div className="space-y-1 text-sm text-gray-600">
                              <button 
                                onClick={() => setGeminiInput('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?')}
                                className="block w-full text-left hover:text-green-600 hover:bg-white p-1 rounded"
                              >
                                üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?
                              </button>
                              <button 
                                onClick={() => setGeminiInput('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?')}
                                className="block w-full text-left hover:text-green-600 hover:bg-white p-1 rounded"
                              >
                                üí∏ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?
                              </button>
                              <button 
                                onClick={() => setGeminiInput('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà')}
                                className="block w-full text-left hover:text-green-600 hover:bg-white p-1 rounded"
                              >
                                ‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
                              </button>
                              <button 
                                onClick={() => setGeminiInput('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà')}
                                className="block w-full text-left hover:text-green-600 hover:bg-white p-1 rounded"
                              >
                                üìä ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
                              </button>
                              <button 
                                onClick={() => setGeminiInput('‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà')}
                                className="block w-full text-left hover:text-green-600 hover:bg-white p-1 rounded"
                              >
                                üí≤ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
                              </button>
                              <button 
                                onClick={() => setGeminiInput('‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà')}
                                className="block w-full text-left hover:text-green-600 hover:bg-white p-1 rounded"
                              >
                                üìà ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
                              </button>
                            </div>
                          </div>
                        </div>
                      ) : (
                        geminiMessages.map((msg, index) => (
                          <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                              msg.sender === 'user'
                                ? 'bg-green-600 text-white'
                                : 'bg-gray-200 text-gray-800'
                            }`}>
                              <p className="whitespace-pre-wrap">{msg.text}</p>
                            </div>
                          </div>
                        ))
                      )}
                      {geminiLoading && (
                        <div className="flex justify-start">
                          <div className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">
                            <div className="flex items-center space-x-2">
                              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600"></div>
                              <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...</span>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Chat Input */}
                    <div className="border-t p-4">
                      <form onSubmit={handleGeminiSend} className="flex space-x-2">
                        <div className="flex-1 relative">
                          <input
                            type="text"
                            value={geminiInput}
                            onChange={(e) => setGeminiInput(e.target.value)}
                            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î..."
                            className="w-full border border-gray-300 rounded-lg px-4 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-green-500 chat-input-mobile"
                            disabled={geminiLoading}
                            autoFocus
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                if (geminiInput.trim() && !geminiLoading) {
                                  handleGeminiSend(e);
                                }
                              }
                            }}
                          />
                          
                          {/* Voice Input Button */}
                          {voiceSupported && (
                            <button
                              type="button"
                              onClick={isListening ? stopVoiceRecording : startVoiceRecording}
                              className={`absolute right-2 top-1/2 transform -translate-y-1/2 p-2 rounded-full transition-colors voice-button ${
                                isListening 
                                  ? 'bg-red-500 text-white recording-pulse' 
                                  : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                              }`}
                              disabled={geminiLoading}
                              title={isListening ? '‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...)' : '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏Å‡∏±‡∏ö AI'}
                            >
                              {isListening ? 'üî¥' : 'üé§'}
                            </button>
                          )}
                        </div>
                        
                        {/* Send Button */}
                        <button
                          type="submit"
                          disabled={geminiLoading || !geminiInput.trim()}
                          className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        >
                          {geminiLoading ? '‚è≥' : 'üì§'}
                        </button>
                        
                        {/* Voice Controls */}
                        {voiceSupported && (
                          <button
                            type="button"
                            onClick={isSpeaking ? stopSpeaking : () => {}}
                            className={`px-4 py-2 rounded-lg transition-colors ${
                              isSpeaking 
                                ? 'bg-red-500 text-white hover:bg-red-600' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            }`}
                            disabled={!isSpeaking}
                            title={isSpeaking ? '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î'}
                          >
                            {isSpeaking ? 'üîá' : 'üîä'}
                          </button>
                        )}
                      </form>
                    </div>
                  </div>
                </div>
              )}

              {/* Tree History Modal */}
              {showTreeModal && selectedTreeHistory && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    {/* Modal Header */}
                    <div className="flex justify-between items-center p-4 md:p-6 border-b bg-green-50">
                      <h3 className="text-lg md:text-xl font-bold text-gray-800">
                        üå¥ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏° {selectedTreeHistory.tree_id}
                      </h3>
                      <button
                        onClick={() => setShowTreeModal(false)}
                        className="text-gray-500 hover:text-gray-700 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors"
                      >
                        √ó
                      </button>
                    </div>

                    {/* Modal Content */}
                    <div className="p-4 md:p-6">
                      {selectedTreeHistory.harvest_history.length > 0 ? (
                        <div>
                          <div className="mb-4 p-3 md:p-4 bg-green-50 rounded-lg">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                              <p className="text-sm text-green-700">
                                üìä <strong>‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß:</strong> {selectedTreeHistory.harvest_history.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                              </p>
                              <p className="text-sm text-green-700">
                                ü•• <strong>‡∏ó‡∏∞‡∏•‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</strong> {selectedTreeHistory.harvest_history.reduce((sum, record) => sum + (record.bunch_count || 0), 0)} ‡∏ó‡∏∞‡∏•‡∏≤‡∏¢
                              </p>
                            </div>
                          </div>

                          {/* History Table - Mobile Optimized */}
                          <div className="hidden md:block overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                              <thead className="bg-gray-50">
                                <tr>
                                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
                                  </th>
                                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢
                                  </th>
                                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                                  </th>
                                </tr>
                              </thead>
                              <tbody className="bg-white divide-y divide-gray-200">
                                {selectedTreeHistory.harvest_history.map((record, index) => (
                                  <tr key={index} className="hover:bg-gray-50">
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                      {formatDateThai(record.harvest_date)}
                                    </td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                      <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        {record.bunch_count} ‡∏ó‡∏∞‡∏•‡∏≤‡∏¢
                                      </span>
                                    </td>
                                    <td className="px-4 py-4 text-sm text-gray-900">
                                      {record.notes || '-'}
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>

                          {/* Mobile Card View */}
                          <div className="md:hidden space-y-3">
                            {selectedTreeHistory.harvest_history.map((record, index) => (
                              <div key={index} className="bg-gray-50 rounded-lg p-4 border">
                                <div className="flex justify-between items-start mb-2">
                                  <div className="font-medium text-gray-900">
                                    {formatDateThai(record.harvest_date)}
                                  </div>
                                  <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    {record.bunch_count} ‡∏ó‡∏∞‡∏•‡∏≤‡∏¢
                                  </span>
                                </div>
                                {record.notes && (
                                  <div className="text-sm text-gray-600 mt-2">
                                    <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> {record.notes}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      ) : (
                        <div className="text-center py-8">
                          <div className="text-gray-400 text-6xl mb-4">üå±</div>
                          <p className="text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏ô‡∏µ‡πâ</p>
                        </div>
                      )}
                    </div>

                    {/* Modal Footer */}
                    <div className="flex justify-end p-4 md:p-6 border-t bg-gray-50">
                      <button
                        onClick={() => setShowTreeModal(false)}
                        className="w-full md:w-auto px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium"
                      >
                        ‡∏õ‡∏¥‡∏î
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );

          // Chart creation functions
          let priceChart = null; // Store chart instance for updates
          const monthLabels = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
          
          const createMonthlyPriceChart = (selectedYear) => {
            console.log('üìä Creating monthly price per kg chart for year:', selectedYear);
            
            const monthlyPricePerKgCtx = document.getElementById('monthlyPricePerKgChart');
            if (!monthlyPricePerKgCtx) {
              console.log('‚ùå monthlyPricePerKgChart element not found');
              return;
            }
            
            // Destroy existing chart if exists
            if (priceChart) {
              console.log('üóëÔ∏è Destroying existing price chart');
              priceChart.destroy();
              priceChart = null;
            }
            
            // Also check Chart.js registry for any existing chart on this canvas
            const existingChart = Chart.getChart(monthlyPricePerKgCtx);
            if (existingChart) {
              console.log('üóëÔ∏è Found existing chart in registry, destroying...');
              existingChart.destroy();
            }
            
            // Calculate average price per kg for each month of selected year
            const monthlyPriceData = monthLabels.map((monthLabel, index) => {
              const monthIndex = index + 1;
              const monthData = harvestData.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getFullYear() === selectedYear && itemDate.getMonth() + 1 === monthIndex;
              });
              
              if (monthData.length === 0) return 0;
              
              // Calculate weighted average price
              const totalRevenue = monthData.reduce((sum, item) => sum + parseFloat(item.total_revenue || 0), 0);
              const totalWeight = monthData.reduce((sum, item) => sum + parseFloat(item.total_weight || 0), 0);
              
              return totalWeight > 0 ? totalRevenue / totalWeight : 0;
            });

            console.log('üìä Creating new price chart instance...');
            priceChart = new Chart(monthlyPricePerKgCtx, {
              type: 'line',
              data: {
                labels: monthLabels,
                datasets: [{
                  label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)',
                  data: monthlyPriceData,
                  borderColor: 'rgb(245, 101, 101)',
                  backgroundColor: 'rgba(245, 101, 101, 0.1)',
                  tension: 0.4,
                  fill: true,
                  pointBackgroundColor: 'rgb(245, 101, 101)',
                  pointBorderColor: 'rgb(220, 38, 127)',
                  pointRadius: 5,
                  pointHoverRadius: 8
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: `‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏µ ${selectedYear + 543})`,
                    font: { size: 14, weight: 'bold' }
                  },
                  legend: { position: 'top' }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: '‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)'
                    },
                    ticks: {
                      callback: function(value) {
                        return value.toFixed(2) + ' ‡∏ø/‡∏Å‡∏Å.';
                      }
                    }
                  },
                  x: {
                    title: {
                      display: true,
                      text: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
                    }
                  }
                },
                interaction: {
                  intersect: false,
                  mode: 'index'
                },
                elements: {
                  point: {
                    hoverBackgroundColor: 'rgb(220, 38, 127)'
                  }
                }
              }
            });
            console.log('‚úÖ Monthly price per kg chart created for year:', selectedYear);
            console.log('üìä Chart instance stored as:', priceChart);
          };
          
          const updatePriceChart = (selectedYear) => {
            console.log('üìä Updating price chart for year:', selectedYear);
            createMonthlyPriceChart(selectedYear);
          };
          
          // Add event listener for price chart updates
          React.useEffect(() => {
            const handlePriceChartUpdate = (event) => {
              if (event.detail && event.detail.year) {
                updatePriceChart(event.detail.year);
              }
            };
            
            document.addEventListener('updatePriceChart', handlePriceChartUpdate);
            
            return () => {
              document.removeEventListener('updatePriceChart', handlePriceChartUpdate);
            };
          }, [harvestData]); // Re-listen when harvest data changes

          const createCharts = () => {
            console.log('üìä createCharts function called');
            console.log('üìä yearlyStats:', yearlyStats);
            console.log('üìä harvestData:', harvestData);
            console.log('üìä fertilizerData:', fertilizerData);
            console.log('üìä palmTreeData:', palmTreeData);
            console.log('üìä Chart.js available:', typeof Chart !== 'undefined');
            console.log('üìä chartJsLoaded flag:', window.chartJsLoaded);
            
            if (typeof Chart === 'undefined') {
              console.error('‚ùå Chart.js is not loaded yet, retrying in 500ms...');
              setTimeout(createCharts, 500);
              return;
            }
            
            // Destroy existing charts to prevent conflicts
            const chartIds = [
              'harvestRevenueChart', 'harvestWeightChart', 'fertilizerCostChart', 
              'palmTreeBunchesChart', 'profitVsCostChart', 'monthlyRevenueProfitChart',
              'monthlyFertilizerCostChart', 'monthlyPalmTreeBunchesChart', 'monthlyHarvestWeightChart',
              'monthlyPricePerKgChart'
            ];
            chartIds.forEach(id => {
              const chart = Chart.getChart(id);
              if (chart) {
                console.log(`üóëÔ∏è Destroying existing chart: ${id}`);
                chart.destroy();
              }
            });

            // Prepare common data
            const allYears = new Set();
            yearlyStats.harvest?.forEach(item => allYears.add(item.year));
            yearlyStats.fertilizer?.forEach(item => allYears.add(item.year));
            yearlyStats.palmtrees?.forEach(item => allYears.add(item.year));
            const years = Array.from(allYears).sort();

            console.log('üìä Years found:', years);

            // Get current year for monthly charts
            const currentYear = new Date().getFullYear();

            // ===== MONTHLY CHARTS =====

            // Monthly Revenue and Profit Chart
            const monthlyRevenueProfitCtx = document.getElementById('monthlyRevenueProfitChart');
            if (monthlyRevenueProfitCtx) {
              console.log('üìä Creating monthly revenue and profit chart...');
              
              let monthlyRevenue = Array(12).fill(0);
              let monthlyProfit = Array(12).fill(0);
              
              if (Array.isArray(harvestData)) {
                harvestData.forEach(item => {
                  if (item.date) {
                    let d;
                    const isoDateRegex = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
                    const thDateRegex = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
                    
                    if (isoDateRegex.test(item.date)) {
                      const match = item.date.match(isoDateRegex);
                      d = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                    } else if (thDateRegex.test(item.date)) {
                      const match = item.date.match(thDateRegex);
                      let year = parseInt(match[3]);
                      if (year > 2400) year -= 543;
                      d = new Date(year, parseInt(match[2]) - 1, parseInt(match[1]));
                    } else {
                      d = new Date(item.date);
                    }
                    
                    if (d && d.getFullYear() === currentYear) {
                      const monthIdx = d.getMonth();
                      monthlyRevenue[monthIdx] += parseFloat(item.total_revenue) || 0;
                      monthlyProfit[monthIdx] += parseFloat(item.net_profit) || 0;
                    }
                  }
                });
              }
              
              console.log('üìä Monthly revenue:', monthlyRevenue);
              console.log('üìä Monthly profit:', monthlyProfit);
              
              new Chart(monthlyRevenueProfitCtx, {
                type: 'line',
                data: {
                  labels: monthLabels,
                  datasets: [
                    {
                      label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                      data: monthlyRevenue,
                      borderColor: 'rgb(34, 197, 94)',
                      backgroundColor: 'rgba(34, 197, 94, 0.1)',
                      tension: 0.4,
                      fill: true
                    },
                    {
                      label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)',
                      data: monthlyProfit,
                      borderColor: 'rgb(59, 130, 246)',
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      tension: 0.4,
                      fill: true
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏ø';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Monthly revenue and profit chart created');
            }

            // Monthly Fertilizer Cost Chart
            const monthlyFertilizerCostCtx = document.getElementById('monthlyFertilizerCostChart');
            if (monthlyFertilizerCostCtx) {
              console.log('üìä Creating monthly fertilizer cost chart...');
              
              let monthlyFertilizerCost = Array(12).fill(0);
              
              if (Array.isArray(fertilizerData)) {
                fertilizerData.forEach(item => {
                  if (item.date) {
                    let d;
                    const isoDateRegex = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
                    const thDateRegex = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
                    
                    if (isoDateRegex.test(item.date)) {
                      const match = item.date.match(isoDateRegex);
                      d = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                    } else if (thDateRegex.test(item.date)) {
                      const match = item.date.match(thDateRegex);
                      let year = parseInt(match[3]);
                      if (year > 2400) year -= 543;
                      d = new Date(year, parseInt(match[2]) - 1, parseInt(match[1]));
                    } else {
                      d = new Date(item.date);
                    }
                    
                    if (d && d.getFullYear() === currentYear) {
                      const monthIdx = d.getMonth();
                      monthlyFertilizerCost[monthIdx] += parseFloat(item.total_cost) || 0;
                    }
                  }
                });
              }
              
              console.log('üìä Monthly fertilizer cost:', monthlyFertilizerCost);
              
              new Chart(monthlyFertilizerCostCtx, {
                type: 'bar',
                data: {
                  labels: monthLabels,
                  datasets: [{
                    label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                    data: monthlyFertilizerCost,
                    backgroundColor: 'rgba(147, 51, 234, 0.8)',
                    borderColor: 'rgb(147, 51, 234)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏ø';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Monthly fertilizer cost chart created');
            }

            // Monthly Palm Tree Bunches Chart
            const monthlyPalmTreeBunchesCtx = document.getElementById('monthlyPalmTreeBunchesChart');
            if (monthlyPalmTreeBunchesCtx) {
              console.log('üìä Creating monthly palm tree bunches chart...');
              
              let monthlyBunches = Array(12).fill(0);
              
              if (Array.isArray(palmTreeData)) {
                palmTreeData.forEach(item => {
                  if (item.harvest_date) {
                    let d;
                    const isoDateRegex = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
                    const thDateRegex = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
                    
                    if (isoDateRegex.test(item.harvest_date)) {
                      const match = item.harvest_date.match(isoDateRegex);
                      d = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                    } else if (thDateRegex.test(item.harvest_date)) {
                      const match = item.harvest_date.match(thDateRegex);
                      let year = parseInt(match[3]);
                      if (year > 2400) year -= 543;
                      d = new Date(year, parseInt(match[2]) - 1, parseInt(match[1]));
                    } else {
                      d = new Date(item.harvest_date);
                    }
                    
                    if (d && d.getFullYear() === currentYear) {
                      const monthIdx = d.getMonth();
                      monthlyBunches[monthIdx] += parseInt(item.bunch_count) || 0;
                    }
                  }
                });
              }
              
              console.log('üìä Monthly bunches:', monthlyBunches);
              
              new Chart(monthlyPalmTreeBunchesCtx, {
                type: 'bar',
                data: {
                  labels: monthLabels,
                  datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢',
                    data: monthlyBunches,
                    backgroundColor: 'rgba(249, 115, 22, 0.8)',
                    borderColor: 'rgb(249, 115, 22)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏ó‡∏∞‡∏•‡∏≤‡∏¢';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Monthly palm tree bunches chart created');
            }

            // Monthly Harvest Weight Chart
            const monthlyHarvestWeightCtx = document.getElementById('monthlyHarvestWeightChart');
            if (monthlyHarvestWeightCtx) {
              console.log('üìä Creating monthly harvest weight chart...');
              
              let monthlyWeight = Array(12).fill(0);
              
              if (Array.isArray(harvestData)) {
                harvestData.forEach(item => {
                  if (item.date) {
                    let d;
                    const isoDateRegex = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
                    const thDateRegex = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
                    
                    if (isoDateRegex.test(item.date)) {
                      const match = item.date.match(isoDateRegex);
                      d = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                    } else if (thDateRegex.test(item.date)) {
                      const match = item.date.match(thDateRegex);
                      let year = parseInt(match[3]);
                      if (year > 2400) year -= 543;
                      d = new Date(year, parseInt(match[2]) - 1, parseInt(match[1]));
                    } else {
                      d = new Date(item.date);
                    }
                    
                    if (d && d.getFullYear() === currentYear) {
                      const monthIdx = d.getMonth();
                      monthlyWeight[monthIdx] += parseFloat(item.total_weight) || 0;
                    }
                  }
                });
              }
              
              console.log('üìä Monthly weight:', monthlyWeight);
              
              new Chart(monthlyHarvestWeightCtx, {
                type: 'line',
                data: {
                  labels: monthLabels,
                  datasets: [{
                    label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏Å‡∏Å.)',
                    data: monthlyWeight,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    fill: true
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏Å‡∏Å.';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Monthly harvest weight chart created');
            }

            // Monthly Price per KG Chart - Initialize for current year
            createMonthlyPriceChart(currentYear);

            // ===== YEARLY CHARTS =====

            if (years.length === 0) {
              console.log('üìä No data years available for yearly charts');
              return;
            }

            // Harvest Revenue Chart
            const harvestRevenueCtx = document.getElementById('harvestRevenueChart');
            console.log('üìä harvestRevenueChart element:', harvestRevenueCtx);
            if (harvestRevenueCtx) {
              console.log('üìä Creating harvest revenue chart...');
              const revenueData = years.map(year => {
                const data = yearlyStats.harvest?.find(h => h.year === year);
                return data ? parseFloat(data.total_revenue) || 0 : 0;
              });
              console.log('üìä Revenue data:', revenueData);
              
              new Chart(harvestRevenueCtx, {
                type: 'line',
                data: {
                  labels: years,
                  datasets: [{
                    label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                    data: revenueData,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    fill: true
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏ø';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Harvest revenue chart created');
            } else {
              console.error('‚ùå harvestRevenueChart element not found');
            }

            // Harvest Weight Chart
            const harvestWeightCtx = document.getElementById('harvestWeightChart');
            console.log('üìä harvestWeightChart element:', harvestWeightCtx);
            if (harvestWeightCtx) {
              console.log('üìä Creating harvest weight chart...');
              const weightData = years.map(year => {
                const data = yearlyStats.harvest?.find(h => h.year === year);
                return data ? parseFloat(data.total_weight) || 0 : 0;
              });
              console.log('üìä Weight data:', weightData);
              
              new Chart(harvestWeightCtx, {
                type: 'bar',
                data: {
                  labels: years,
                  datasets: [{
                    label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)',
                    data: weightData,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏Å‡∏Å.';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Harvest weight chart created');
            } else {
              console.error('‚ùå harvestWeightChart element not found');
            }

            // Fertilizer Cost Chart
            const fertilizerCostCtx = document.getElementById('fertilizerCostChart');
            console.log('üìä fertilizerCostChart element:', fertilizerCostCtx);
            if (fertilizerCostCtx) {
              console.log('üìä Creating fertilizer cost chart...');
              const costData = years.map(year => {
                const data = yearlyStats.fertilizer?.find(f => f.year === year);
                return data ? parseFloat(data.total_cost) || 0 : 0;
              });
              console.log('üìä Fertilizer cost data:', costData);
              
              new Chart(fertilizerCostCtx, {
                type: 'bar',
                data: {
                  labels: years,
                  datasets: [{
                    label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                    data: costData,
                    backgroundColor: 'rgba(147, 51, 234, 0.8)',
                    borderColor: 'rgb(147, 51, 234)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏ø';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Fertilizer cost chart created');
            } else {
              console.error('‚ùå fertilizerCostChart element not found');
            }

            // Palm Tree Bunches Chart (Yearly)
            const palmTreeBunchesCtx = document.getElementById('palmTreeBunchesChart');
            console.log('üìä palmTreeBunchesChart element:', palmTreeBunchesCtx);
            if (palmTreeBunchesCtx) {
              console.log('üìä Creating yearly palm tree bunches chart...');
              const bunchesData = years.map(year => {
                const data = yearlyStats.palmtrees?.find(p => p.year === year);
                return data ? parseFloat(data.total_bunches) || 0 : 0;
              });
              console.log('üìä Yearly bunches data:', bunchesData);
              
              new Chart(palmTreeBunchesCtx, {
                type: 'bar',
                data: {
                  labels: years,
                  datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏∞‡∏•‡∏≤‡∏¢‡∏£‡∏ß‡∏°',
                    data: bunchesData,
                    backgroundColor: 'rgba(249, 115, 22, 0.8)',
                    borderColor: 'rgb(249, 115, 22)',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏ó‡∏∞‡∏•‡∏≤‡∏¢';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Yearly palm tree bunches chart created');
            } else {
              console.error('‚ùå palmTreeBunchesChart element not found');
            }

            // Profit vs Cost Comparison Chart
            const profitVsCostCtx = document.getElementById('profitVsCostChart');
            console.log('üìä profitVsCostCtx element:', profitVsCostCtx);
            if (profitVsCostCtx) {
              console.log('üìä Creating profit vs cost chart...');
              const profitData = years.map(year => {
                const data = yearlyStats.harvest?.find(h => h.year === year);
                return data ? parseFloat(data.total_profit) || 0 : 0;
              });
              const costData = years.map(year => {
                const data = yearlyStats.fertilizer?.find(f => f.year === year);
                return data ? parseFloat(data.total_cost) || 0 : 0;
              });
              console.log('üìä Profit data:', profitData);
              console.log('üìä Fertilizer cost data:', costData);
              
              new Chart(profitVsCostCtx, {
                type: 'line',
                data: {
                  labels: years,
                  datasets: [
                    {
                      label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)',
                      data: profitData,
                      borderColor: 'rgb(34, 197, 94)',
                      backgroundColor: 'rgba(34, 197, 94, 0.1)',
                      tension: 0.4,
                      fill: false
                    },
                    {
                      label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                      data: costData,
                      borderColor: 'rgb(239, 68, 68)',
                      backgroundColor: 'rgba(239, 68, 68, 0.1)',
                      tension: 0.4,
                      fill: false
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' ‡∏ø';
                        }
                      }
                    }
                  }
                }
              });
              console.log('‚úÖ Profit vs cost chart created');
            } else {
              console.error('‚ùå profitVsCostCtx element not found');
            }
          };

          // Create charts when yearly stats are loaded
          React.useEffect(() => {
            console.log('üìä useEffect triggered for charts');
            console.log('   activeTab:', activeTab);
            console.log('   yearlyStats:', yearlyStats);
            console.log('   Chart.js available:', typeof Chart !== 'undefined');
            
            if (activeTab === 'reports' && yearlyStats) {
              console.log('üìä Conditions met for chart creation');
              
              // Check if we have data
              const hasData = (yearlyStats.harvest?.length > 0 || yearlyStats.fertilizer?.length > 0 || yearlyStats.palmtrees?.length > 0);
              console.log('   Has data:', hasData);
              
              if (hasData) {
                // Function to check Chart.js and create charts
                const tryCreateCharts = () => {
                  if (typeof Chart !== 'undefined') {
                    console.log('üìä Chart.js ready, creating charts...');
                    setTimeout(createCharts, 100);
                  } else {
                    console.log('üìä Chart.js not ready, retrying in 100ms...');
                    setTimeout(tryCreateCharts, 100);
                  }
                };
                
                tryCreateCharts();
              } else {
                console.log('üìä No data available for charts');
              }
            }
          }, [activeTab, yearlyStats]);

          return currentUser ? <Dashboard /> : <AuthForm />;
        };

        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Global functions for chart updates
        window.updatePriceChart = (selectedYear) => {
          console.log('üìä Global updatePriceChart called for year:', selectedYear);
          // Find the price chart update function and call it
          setTimeout(() => {
            const event = new CustomEvent('updatePriceChart', { detail: { year: selectedYear } });
            document.dispatchEvent(event);
          }, 100);
        };
    </script>
</body>
</html>
